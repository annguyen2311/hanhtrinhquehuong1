<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelGenie AI - Du L·ªãch Th√¥ng Minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #050511;
            color: #fff;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-cyber {
            background: radial-gradient(circle at 50% 50%, #1a1a40 0%, #050511 100%);
            position: fixed;
            inset: 0;
            z-index: -2;
        }
        
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            animation: float 20s infinite ease-in-out;
        }
        .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: rgba(139, 92, 246, 0.15); animation-delay: 0s; }
        .orb-2 { bottom: -10%; right: -10%; width: 40vw; height: 40vw; background: rgba(6, 182, 212, 0.15); animation-delay: -5s; }
        .orb-3 { top: 40%; left: 40%; width: 30vw; height: 30vw; background: rgba(236, 72, 153, 0.1); animation-delay: -10s; }

        @keyframes float { 0% { transform: translate(0, 0); } 33% { transform: translate(30px, -50px); } 66% { transform: translate(-20px, 20px); } 100% { transform: translate(0, 0); } }

        /* Glassmorphism & Neon */
        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-input:focus {
            outline: none;
            border-color: #a855f7;
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
        }

        .neon-border {
            position: relative;
        }
        .neon-border::after {
            content: '';
            position: absolute;
            inset: -1px;
            background: linear-gradient(45deg, #06b6d4, #a855f7, #ec4899);
            z-index: -1;
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .neon-border:hover::after, .neon-border:focus-within::after {
            opacity: 1;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .pulse-glow { animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); } 100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); } }

        /* Utilities */
        .text-gradient {
            background: linear-gradient(to right, #22d3ee, #e879f9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .btn-primary:hover::before { left: 100%; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050511; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid rgba(139, 92, 246, 0.2);
            z-index: 99;
            top: 100%; left: 0; right: 0;
            background: rgba(10, 10, 25, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            margin-top: 4px;
        }
        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #cbd5e1;
            font-size: 13px;
            transition: all 0.2s;
        }
        .autocomplete-item:hover {
            background: linear-gradient(90deg, rgba(168, 85, 247, 0.1), transparent);
            color: #fff;
            padding-left: 20px;
        }
        
        .bg-error {
             background: rgba(239, 68, 68, 0.1);
             border: 1px solid rgba(239, 68, 68, 0.2);
             color: #f87171;
        }
        
        .hidden { display: none !important; }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.run/@google/genai",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.557.0"
  }
}
</script>
</head>
<body>

    <!-- Background -->
    <div class="bg-cyber"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <!-- API Key Modal (GATEKEEPER - Shows BEFORE Auth) -->
    <div id="api-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#050511]/95 backdrop-blur-xl hidden">
        <div class="glass-panel max-w-md w-full p-8 rounded-3xl border border-cyan-500/30 shadow-[0_0_50px_rgba(6,182,212,0.15)] relative animate-[fadeIn_0.4s_cubic-bezier(0.16,1,0.3,1)] overflow-hidden">
            <!-- Decorative Elements -->
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500"></div>
            <div class="absolute -right-10 -top-10 w-32 h-32 bg-cyan-500/10 blur-3xl rounded-full pointer-events-none"></div>

            <div class="text-center mb-8 relative z-10">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-b from-cyan-900/50 to-transparent border border-cyan-500/30 flex items-center justify-center relative">
                    <div class="absolute inset-0 rounded-full border border-cyan-400/50 animate-[ping_2s_infinite]"></div>
                    <i data-lucide="shield-alert" class="text-cyan-400 w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2 tracking-tight">K√çCH HO·∫†T H·ªÜ TH·ªêNG</h3>
                <p class="text-sm text-slate-400 leading-relaxed">
                    Vui l√≤ng nh·∫≠p <b>Google Gemini API Key</b> ƒë·ªÉ kh·ªüi ƒë·ªông c√°c t√≠nh nƒÉng AI Core tr∆∞·ªõc khi ƒëƒÉng nh·∫≠p.
                </p>
            </div>
            
            <form id="modal-api-form" class="space-y-6 relative z-10">
                <div class="relative group">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-cyan-500 to-purple-600 rounded-xl opacity-30 group-focus-within:opacity-100 transition duration-500 blur"></div>
                    <div class="relative">
                        <input type="password" id="modal-input-key" placeholder="D√°n API Key c·ªßa b·∫°n v√†o ƒë√¢y..." class="w-full bg-[#0a0a1a] text-white px-4 py-4 rounded-xl text-sm border border-white/10 focus:outline-none font-mono">
                        <i data-lucide="key" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4"></i>
                    </div>
                </div>
                
                <div class="flex flex-col gap-3">
                    <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold text-sm shadow-lg shadow-cyan-900/30 transition-all transform hover:-translate-y-0.5 uppercase tracking-widest flex items-center justify-center gap-2">
                        <i data-lucide="power" class="w-4 h-4"></i> K√≠ch Ho·∫°t Ngay
                    </button>
                    
                    <button type="button" onclick="closeApiModal()" class="w-full py-3 rounded-xl border border-white/10 hover:bg-white/5 text-slate-400 hover:text-white font-medium text-xs transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="x-circle" class="w-4 h-4"></i> B·ªè Qua (Ch·∫ø ƒê·ªô Offline)
                    </button>
                </div>
            </form>
            
            <div class="mt-6 text-center border-t border-white/5 pt-4">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-cyan-400 hover:text-cyan-300 flex items-center justify-center gap-1 transition-colors">
                    Ch∆∞a c√≥ Key? L·∫•y mi·ªÖn ph√≠ t·∫°i ƒë√¢y <i data-lucide="external-link" class="w-3 h-3"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Auth View -->
    <div id="view-auth" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-8 rounded-3xl fade-in relative overflow-hidden neon-border">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500"></div>
            
            <div class="text-center mb-10">
                <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-cyan-500/20 to-purple-500/20 border border-white/10 flex items-center justify-center relative">
                    <div class="absolute inset-0 rounded-2xl bg-gradient-to-br from-cyan-400 to-purple-500 opacity-20 blur-xl"></div>
                    <i data-lucide="plane" class="text-white w-10 h-10 relative z-10"></i>
                </div>
                <h1 class="text-4xl font-bold text-white mb-2 tracking-tight">TravelGenie <span class="text-cyan-400 text-sm align-top">AI</span></h1>
                <p class="text-slate-400 text-sm font-light tracking-wide">TR·ª¢ L√ù DU L·ªäCH TH·∫æ H·ªÜ M·ªöI</p>
            </div>

            <div class="flex bg-black/20 p-1.5 rounded-xl mb-8 border border-white/5">
                <button id="tab-login" class="flex-1 py-2.5 rounded-lg text-sm font-medium transition-all bg-white/10 text-white shadow-lg">ƒêƒÉng Nh·∫≠p</button>
                <button id="tab-register" class="flex-1 py-2.5 rounded-lg text-sm font-medium transition-all text-slate-500 hover:text-white">ƒêƒÉng K√Ω</button>
            </div>

            <form id="auth-form" class="space-y-5">
                <div id="field-name" class="hidden animate-[fadeIn_0.3s]">
                    <div class="relative group">
                        <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4 group-focus-within:text-cyan-400 transition-colors"></i>
                        <input type="text" id="input-name" placeholder="H·ªç t√™n hi·ªÉn th·ªã" class="glass-input w-full pl-12 pr-4 py-3.5 rounded-xl text-sm">
                    </div>
                </div>
                <div class="relative group">
                    <i data-lucide="mail" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4 group-focus-within:text-cyan-400 transition-colors"></i>
                    <input type="email" id="input-email" placeholder="Email ƒë·ªãnh danh" required class="glass-input w-full pl-12 pr-4 py-3.5 rounded-xl text-sm">
                </div>
                <div class="relative group">
                    <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4 group-focus-within:text-cyan-400 transition-colors"></i>
                    <input type="password" id="input-password" placeholder="M·∫≠t m√£ b·∫£o v·ªá" required class="glass-input w-full pl-12 pr-4 py-3.5 rounded-xl text-sm">
                </div>
                
                <p id="auth-error" class="text-red-400 text-xs text-center hidden bg-error py-3 rounded-lg flex items-center justify-center gap-2">
                    <i data-lucide="alert-circle" class="w-3 h-3"></i> <span id="auth-error-text"></span>
                </p>

                <button type="submit" class="btn-primary w-full py-3.5 rounded-xl font-bold text-sm text-white shadow-lg shadow-purple-500/20 tracking-wide uppercase">
                    <span id="btn-auth-text">Truy C·∫≠p H·ªá Th·ªëng</span>
                </button>
            </form>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden flex-col min-h-screen">
        
        <!-- Navbar -->
        <nav class="sticky top-0 z-40 border-b border-white/5 bg-[#050511]/80 backdrop-blur-xl">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="navigateTo('home')">
                    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-cyan-400 to-purple-600 flex items-center justify-center group-hover:shadow-[0_0_15px_rgba(168,85,247,0.5)] transition-all">
                        <i data-lucide="plane" class="text-white w-5 h-5"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight hidden md:block">TravelGenie</span>
                </div>

                <div class="flex items-center gap-1 bg-white/5 p-1 rounded-xl border border-white/5">
                    <button onclick="navigateTo('home')" class="nav-btn flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white transition-all" data-target="home">
                        <i data-lucide="search" class="w-4 h-4"></i> <span class="hidden md:inline">Kh√°m Ph√°</span>
                    </button>
                    <button onclick="navigateTo('chat')" class="nav-btn flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white transition-all" data-target="chat">
                        <i data-lucide="message-square" class="w-4 h-4"></i> <span class="hidden md:inline">AI Chat</span>
                    </button>
                    <button onclick="navigateTo('profile')" class="nav-btn flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white transition-all relative" data-target="profile">
                        <i data-lucide="user" class="w-4 h-4"></i> <span class="hidden md:inline">H·ªì S∆°</span>
                        <span id="nav-status-dot" class="absolute top-1.5 right-1.5 w-2 h-2 rounded-full bg-slate-500 border border-[#050511]"></span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow relative">
            
            <!-- Home View -->
            <div id="view-home" class="view-section px-4 py-12 pb-24 fade-in">
                <div class="max-w-4xl mx-auto text-center mb-14 relative">
                    <div class="absolute -top-20 left-1/2 -translate-x-1/2 w-64 h-64 bg-purple-500/20 blur-[100px] rounded-full pointer-events-none"></div>
                    <h1 class="text-5xl md:text-6xl font-bold mb-6 text-white leading-tight tracking-tight">
                        Kh√°m ph√° th·∫ø gi·ªõi <br />
                        <span class="text-gradient">Kh√¥ng gi·ªõi h·∫°n</span>
                    </h1>
                    <p class="text-lg text-slate-400 max-w-xl mx-auto font-light">
                        C√¥ng ngh·ªá AI t·ªëi ∆∞u h√≥a h√†nh tr√¨nh c·ªßa b·∫°n. T√¨m v√© m√°y bay, kh√°ch s·∫°n v·ªõi chi ph√≠ t·ªët nh·∫•t ch·ªâ trong v√†i gi√¢y.
                    </p>
                </div>

                <div class="max-w-5xl mx-auto glass-panel p-8 rounded-3xl border border-white/10 mb-20 shadow-2xl relative neon-border">
                    <form id="search-form" class="grid grid-cols-1 md:grid-cols-4 gap-5">
                        <div class="col-span-1 group">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Lo·∫°i h√¨nh</label>
                            <div class="relative">
                                <select id="search-type" class="glass-input w-full px-4 py-3.5 rounded-xl text-sm appearance-none cursor-pointer">
                                    <option value="Flight" class="bg-slate-900">‚úàÔ∏è Chuy·∫øn Bay</option>
                                    <option value="Train" class="bg-slate-900">üöÑ T√†u H·ªèa</option>
                                    <option value="Bus" class="bg-slate-900">üöå Xe Kh√°ch</option>
                                    <option value="Hotel" class="bg-slate-900">üè® L∆∞u Tr√∫</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div class="col-span-1 relative group" id="container-origin">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">ƒêi·ªÉm Xu·∫•t Ph√°t</label>
                            <div class="relative">
                                <i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 group-focus-within:text-cyan-400 transition-colors"></i>
                                <input type="text" id="search-origin" placeholder="H√† N·ªôi..." class="glass-input w-full pl-11 pr-4 py-3.5 rounded-xl text-sm" autocomplete="off">
                                <div id="suggestions-origin" class="autocomplete-items hidden"></div>
                            </div>
                        </div>
                        <div class="col-span-1 relative group" id="container-destination">
                            <label id="label-destination" class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">ƒêi·ªÉm ƒê·∫øn</label>
                            <div class="relative">
                                <i data-lucide="map" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 group-focus-within:text-purple-400 transition-colors"></i>
                                <input type="text" id="search-destination" placeholder="ƒê√† N·∫µng..." required class="glass-input w-full pl-11 pr-4 py-3.5 rounded-xl text-sm" autocomplete="off">
                                <div id="suggestions-destination" class="autocomplete-items hidden"></div>
                            </div>
                        </div>
                        <div class="col-span-1 group">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-1">Th·ªùi Gian</label>
                            <div class="relative">
                                <input type="date" id="search-date" required class="glass-input w-full px-4 py-3.5 rounded-xl text-sm text-slate-300">
                            </div>
                        </div>
                        <div class="md:col-span-4 flex justify-end mt-2">
                            <button type="submit" class="btn-primary px-10 py-4 rounded-xl font-bold text-white shadow-lg text-sm uppercase tracking-widest flex items-center gap-2">
                                <i data-lucide="search" class="w-4 h-4"></i> T√¨m Ki·∫øm Ngay
                            </button>
                        </div>
                    </form>
                </div>

                <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Feature Cards -->
                    <div class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition-all duration-300 group">
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-500/20 to-pink-500/20 flex items-center justify-center mb-4 border border-purple-500/30 group-hover:scale-110 transition-transform">
                            <i data-lucide="zap" class="text-purple-400"></i>
                        </div>
                        <h3 class="text-lg font-bold mb-2 text-white group-hover:text-purple-300 transition-colors">X·ª≠ L√Ω T·ªëc ƒê·ªô Cao</h3>
                        <p class="text-sm text-slate-400">Thu·∫≠t to√°n t·ªëi ∆∞u h√≥a gi√∫p t√¨m ki·∫øm k·∫øt qu·∫£ ph√π h·ª£p nh·∫•t trong mili gi√¢y.</p>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition-all duration-300 group">
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-cyan-400/20 to-blue-500/20 flex items-center justify-center mb-4 border border-cyan-500/30 group-hover:scale-110 transition-transform">
                            <i data-lucide="globe" class="text-cyan-400"></i>
                        </div>
                        <h3 class="text-lg font-bold mb-2 text-white group-hover:text-cyan-300 transition-colors">K·∫øt N·ªëi To√†n C·∫ßu</h3>
                        <p class="text-sm text-slate-400">Deep-link tr·ª±c ti·∫øp ƒë·∫øn c√°c n·ªÅn t·∫£ng ƒë·∫∑t v√© h√†ng ƒë·∫ßu th·∫ø gi·ªõi.</p>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition-all duration-300 group">
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-emerald-400/20 to-teal-500/20 flex items-center justify-center mb-4 border border-emerald-500/30 group-hover:scale-110 transition-transform">
                            <i data-lucide="cpu" class="text-emerald-400"></i>
                        </div>
                        <h3 class="text-lg font-bold mb-2 text-white group-hover:text-emerald-300 transition-colors">AI Core 2.0</h3>
                        <p class="text-sm text-slate-400">Tr·ª£ l√Ω ·∫£o th√¥ng minh h·ªó tr·ª£ gi·∫£i ƒë√°p m·ªçi th·∫Øc m·∫Øc v·ªÅ h√†nh tr√¨nh.</p>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loading-overlay" class="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-[#050511]/90 backdrop-blur-md hidden fade-in">
                <div class="relative">
                    <div class="w-20 h-20 border-t-2 border-b-2 border-cyan-400 rounded-full spin"></div>
                    <div class="w-20 h-20 border-r-2 border-l-2 border-purple-500 rounded-full spin absolute inset-0 animation-delay-500" style="animation-direction: reverse;"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i data-lucide="plane" class="w-6 h-6 text-white"></i>
                    </div>
                </div>
                <h3 class="text-xl font-bold mt-8 mb-2 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 animate-pulse">ƒêANG QU√âT D·ªÆ LI·ªÜU...</h3>
                <p class="text-slate-400 text-sm font-mono tracking-widest">CONNECTING TO PROVIDERS</p>
            </div>

            <!-- Results View -->
            <div id="view-results" class="view-section hidden px-4 py-8 pb-24 fade-in">
                <div class="max-w-7xl mx-auto">
                    <button onclick="navigateTo('home')" class="group flex items-center text-slate-400 hover:text-cyan-400 mb-8 text-sm transition-colors uppercase tracking-wider font-bold">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform"></i> Quay l·∫°i
                    </button>

                    <div class="mb-10 p-6 glass-panel rounded-2xl border border-white/5 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-full bg-gradient-to-l from-purple-900/20 to-transparent"></div>
                        <h2 class="text-2xl md:text-3xl font-bold flex flex-wrap items-center gap-4 mb-2 relative z-10">
                            <span id="res-origin" class="text-slate-300">HAN</span>
                            <div class="w-8 h-1 bg-gradient-to-r from-slate-700 to-slate-700 rounded-full overflow-hidden relative">
                                <div class="absolute inset-0 bg-gradient-to-r from-cyan-400 to-purple-500 w-1/2 animate-[shimmer_2s_infinite]"></div>
                            </div>
                            <span id="res-destination" class="text-white">DAD</span>
                        </h2>
                        <div class="flex items-center gap-6 text-sm text-slate-400 font-mono mt-4">
                            <div class="flex items-center gap-2">
                                <i data-lucide="calendar" class="w-4 h-4 text-cyan-400"></i>
                                <span id="res-date">2023-10-10</span>
                            </div>
                        </div>

                        <!-- REAL SEARCH LINKS -->
                        <div id="real-search-links" class="mt-6 pt-6 border-t border-white/10 flex flex-col md:flex-row items-center justify-between gap-6">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-yellow-500/10 border border-yellow-500/30 flex items-center justify-center text-yellow-400 pulse-glow">
                                    <i data-lucide="external-link" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-yellow-400 text-sm uppercase tracking-wide">D·ªØ li·ªáu th·ªùi gian th·ª±c</h4>
                                    <p class="text-xs text-slate-400">K·∫øt n·ªëi tr·ª±c ti·∫øp v·ªõi ƒë·ªëi t√°c ƒë·ªÉ c√≥ gi√° ch√≠nh x√°c nh·∫•t</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-3" id="external-buttons-container">
                                <!-- JS Injected -->
                            </div>
                        </div>
                    </div>

                    <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Tickets generated via JS -->
                    </div>
                </div>
            </div>

            <!-- Chat View -->
            <div id="view-chat" class="view-section hidden h-[calc(100vh-64px)] flex flex-col relative max-w-5xl mx-auto pt-4 md:pt-8">
                <div id="chat-messages" class="flex-1 overflow-y-auto px-4 pb-4 space-y-6 scroll-smooth">
                    <!-- Default msg will be here -->
                </div>

                <div class="p-4 md:p-6 mt-auto bg-[#050511]/90 backdrop-blur-xl border-t border-white/10">
                    <form id="chat-form" class="relative flex gap-3 items-center max-w-4xl mx-auto">
                        <div class="relative flex-1 group">
                            <input type="text" id="chat-input" placeholder="Nh·∫≠p c√¢u h·ªèi cho AI..." class="glass-input w-full pl-5 pr-12 py-4 rounded-xl text-sm focus:ring-2 focus:ring-purple-500/50" autocomplete="off">
                            <div class="absolute inset-0 rounded-xl pointer-events-none border border-white/5 group-hover:border-white/10 transition-colors"></div>
                        </div>
                        <button type="submit" class="p-4 bg-gradient-to-r from-cyan-500 to-purple-600 rounded-xl text-white shadow-lg hover:shadow-purple-500/40 hover:-translate-y-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                    <p class="text-center text-[10px] text-slate-600 mt-2 uppercase tracking-wider">Powered by Gemini 2.5 Flash</p>
                </div>
            </div>

            <!-- Profile View -->
            <div id="view-profile" class="view-section hidden min-h-[80vh] flex items-center justify-center p-4 fade-in">
                <div class="glass-panel w-full max-w-2xl rounded-3xl p-8 border border-white/10 relative overflow-hidden">
                    <!-- Decor -->
                    <div class="absolute -top-24 -right-24 w-48 h-48 bg-cyan-500/20 blur-[60px] rounded-full"></div>
                    <div class="absolute -bottom-24 -left-24 w-48 h-48 bg-purple-500/20 blur-[60px] rounded-full"></div>
                    
                    <div class="relative flex flex-col md:flex-row items-center gap-8 mb-10">
                        <div class="w-28 h-28 rounded-full p-1 bg-gradient-to-br from-cyan-400 to-purple-500 shadow-[0_0_30px_rgba(168,85,247,0.3)]">
                            <img src="https://picsum.photos/200/200" alt="Avatar" class="w-full h-full rounded-full object-cover border-4 border-[#050511]">
                        </div>
                        <div class="text-center md:text-left">
                            <h2 id="profile-name" class="text-3xl font-bold text-white mb-1">User Name</h2>
                            <p id="profile-email" class="text-slate-400 text-sm font-mono bg-white/5 px-3 py-1 rounded-full inline-block">user@example.com</p>
                        </div>
                    </div>

                    <!-- AI Configuration Section -->
                    <div class="bg-black/30 rounded-2xl p-6 border border-white/10 mb-8 relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-cyan-400 to-purple-500"></div>
                        
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-white/5 flex items-center justify-center">
                                    <i data-lucide="cpu" class="text-cyan-400 w-5 h-5"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-white text-sm uppercase tracking-wide">Tr·∫°ng th√°i AI Core</h3>
                                    <p id="profile-api-status" class="text-xs text-slate-400">ƒêang ki·ªÉm tra...</p>
                                </div>
                            </div>
                            <div id="status-badge" class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-slate-800 text-slate-400 border border-slate-700">
                                OFFLINE
                            </div>
                        </div>

                        <form id="profile-api-form" class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Google Gemini API Key</label>
                                <div class="relative">
                                    <input type="password" id="profile-api-key" placeholder="Nh·∫≠p API Key ƒë·ªÉ k√≠ch ho·∫°t t√≠nh nƒÉng th√¥ng minh..." class="glass-input w-full pl-10 pr-4 py-3 rounded-xl text-xs font-mono tracking-wide">
                                    <i data-lucide="key" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-600"></i>
                                </div>
                            </div>
                            <div class="flex justify-end gap-3">
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="px-4 py-2 rounded-lg text-xs font-medium text-slate-400 hover:text-white transition-colors flex items-center gap-2">
                                    L·∫•y Key <i data-lucide="external-link" class="w-3 h-3"></i>
                                </a>
                                <button type="submit" class="px-6 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white text-xs font-bold uppercase tracking-wider transition-all shadow-lg shadow-cyan-900/20">
                                    L∆∞u C·∫•u H√¨nh
                                </button>
                            </div>
                        </form>
                    </div>

                    <button onclick="logout()" class="w-full py-3.5 rounded-xl border border-red-500/20 text-red-400 hover:bg-red-500/10 hover:text-red-300 hover:border-red-500/40 flex items-center justify-center gap-2 transition-all text-sm font-bold uppercase tracking-widest">
                        <i data-lucide="log-out" class="w-4 h-4"></i> ƒêƒÉng Xu·∫•t H·ªá Th·ªëng
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- Logic -->
    <script type="module">
        import { GoogleGenAI } from "https://esm.run/@google/genai";

        // Constants
        const LOCATIONS = ["H√† N·ªôi", "H·ªì Ch√≠ Minh", "ƒê√† N·∫µng", "H·∫£i Ph√≤ng", "C·∫ßn Th∆°", "Ph√∫ Qu·ªëc", "Nha Trang", "ƒê√† L·∫°t", "Hu·∫ø", "H·ªôi An", "Sapa", "V≈©ng T√†u", "Quy Nh∆°n", "Bu√¥n Ma Thu·ªôt"];
        const PROVIDERS = {
            'Flight': ["Vietnam Airlines", "Vietjet Air", "Bamboo Airways"],
            'Train': ["Vietnam Railways", "Livitrans Express"],
            'Bus': ["Ph∆∞∆°ng Trang", "Th√†nh B∆∞·ªüi", "Kumho Samco"],
            'Hotel': ["InterContinental", "Sheraton", "Novotel", "Vinpearl", "M∆∞·ªùng Thanh"]
        };

        const state = {
            user: null,
            apiKey: localStorage.getItem('tg_api_key') || '',
            isOffline: false,
            currentView: 'auth'
        };

        let genAI = null;
        let chatSession = null;

        // --- Core Functions ---

        function initGemini(key) {
            if (!key) return false;
            try {
                genAI = new GoogleGenAI({ apiKey: key });
                chatSession = genAI.chats.create({
                    model: 'gemini-2.5-flash',
                    config: { systemInstruction: "B·∫°n l√† TravelGenie, tr·ª£ l√Ω du l·ªãch chuy√™n nghi·ªáp. Tr·∫£ l·ªùi ng·∫Øn g·ªçn, th√¢n thi·ªán b·∫±ng ti·∫øng Vi·ªát." }
                });
                state.apiKey = key;
                localStorage.setItem('tg_api_key', key);
                state.isOffline = false;
                updateStatusUI(true);
                return true;
            } catch (e) {
                console.error("Init failed", e);
                return false;
            }
        }

        function checkGatekeeper() {
            // Check API Key immediately
            const storedKey = localStorage.getItem('tg_api_key');
            if (storedKey) {
                state.apiKey = storedKey;
                initGemini(storedKey);
                document.getElementById('api-modal').classList.add('hidden');
            } else {
                // Force show modal if no key
                document.getElementById('api-modal').classList.remove('hidden');
            }
        }

        function updateStatusUI(isOnline) {
            // Navbar dot
            const navDot = document.getElementById('nav-status-dot');
            if (isOnline) {
                navDot.className = "absolute top-1.5 right-1.5 w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981] border border-[#050511]";
            } else {
                navDot.className = "absolute top-1.5 right-1.5 w-2 h-2 rounded-full bg-red-500 border border-[#050511]";
            }

            // Profile status
            const badge = document.getElementById('status-badge');
            const text = document.getElementById('profile-api-status');
            
            if (badge && text) {
                if (isOnline) {
                    badge.className = "px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-emerald-500/10 text-emerald-400 border border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)]";
                    badge.textContent = "ONLINE";
                    text.textContent = "H·ªá th·ªëng ƒë√£ k·∫øt n·ªëi Gemini AI";
                    text.className = "text-xs text-emerald-400";
                } else {
                    badge.className = "px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-red-500/10 text-red-400 border border-red-500/30";
                    badge.textContent = "OFFLINE";
                    text.textContent = "Ch∆∞a k·∫øt n·ªëi API Key";
                    text.className = "text-xs text-slate-400";
                }
            }
            
            // Sync Input in Profile
            const profileInput = document.getElementById('profile-api-key');
            if (profileInput) profileInput.value = state.apiKey;
        }

        window.closeApiModal = function() {
            document.getElementById('api-modal').classList.add('hidden');
            state.isOffline = true;
            updateStatusUI(false);
            // Intro message for offline mode
            addBotMessage("T√¥i ƒëang ho·∫°t ƒë·ªông ·ªü ch·∫ø ƒë·ªô Offline. T√¥i ch·ªâ c√≥ th·ªÉ tr·∫£ l·ªùi c√°c c√¢u h·ªèi c∆° b·∫£n ho·∫∑c b·∫°n c√≥ th·ªÉ d√πng t√≠nh nƒÉng T√¨m Ki·∫øm.");
        };

        function addBotMessage(text) {
            const chatBox = document.getElementById('chat-messages');
            if(!chatBox) return;
            const div = document.createElement('div');
            div.className = 'flex items-start gap-4 animate-[fadeIn_0.3s]';
            div.innerHTML = `
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-400/20 to-purple-500/20 border border-white/10 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="bot" class="text-cyan-400 w-5 h-5"></i>
                </div>
                <div class="glass-panel px-6 py-4 rounded-2xl rounded-tl-none max-w-[85%] text-sm leading-relaxed text-slate-200 shadow-lg">
                    ${text}
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            lucide.createIcons();
        }

        // --- Mock Data ---
        function generateTickets(type, origin, dest, date) {
            const count = Math.floor(Math.random() * 5) + 3;
            const tickets = [];
            const providerList = PROVIDERS[type] || PROVIDERS['Flight'];
            
            for(let i=0; i<count; i++) {
                const price = (Math.floor(Math.random() * 200) + 50) * 10000;
                const h = Math.floor(Math.random() * 14) + 6;
                const m = Math.floor(Math.random() * 6) * 10;
                const time = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                
                let link = '#';
                if(type === 'Flight') link = `https://www.google.com/search?q=v√©+m√°y+bay+${origin}+ƒëi+${dest}+${date}`;
                else if(type === 'Hotel') link = `https://www.google.com/search?q=kh√°ch+s·∫°n+t·∫°i+${dest}+${date}`;
                else link = `https://www.google.com/search?q=v√©+${type === 'Train'?'t√†u':'xe'}+${origin}+ƒëi+${dest}`;

                tickets.push({
                    provider: providerList[Math.floor(Math.random() * providerList.length)],
                    time, price: new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(price),
                    link, type
                });
            }
            return tickets.sort((a,b) => parseFloat(a.price) - parseFloat(b.price));
        }

        // --- View Navigation ---
        window.navigateTo = function(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            
            // Navbar state
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === viewId) {
                    btn.classList.add('bg-white/10', 'text-white');
                    btn.classList.remove('text-slate-400');
                } else {
                    btn.classList.remove('bg-white/10', 'text-white');
                    btn.classList.add('text-slate-400');
                }
            });
            lucide.createIcons();
        };

        function updateAuthUI() {
            if (state.user) {
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('flex');
                
                document.getElementById('profile-name').textContent = state.user.name;
                document.getElementById('profile-email').textContent = state.user.email;
                
                navigateTo('home');
            } else {
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('flex');
                document.getElementById('view-auth').classList.remove('hidden');
            }
        }
        
        function showError(msg) {
            const el = document.getElementById('auth-error');
            const txt = document.getElementById('auth-error-text');
            if(msg) {
                el.classList.remove('hidden');
                txt.textContent = msg;
            } else {
                el.classList.add('hidden');
            }
        }

        // --- Event Listeners ---

        // Auth
        document.getElementById('auth-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('input-email').value;
            const password = document.getElementById('input-password').value;
            const name = document.getElementById('input-name').value;
            const isLogin = document.getElementById('field-name').classList.contains('hidden');
            
            // Load Users DB
            const usersDB = JSON.parse(localStorage.getItem('tg_users_db') || '[]');
            
            if (isLogin) {
                // LOGIN LOGIC
                const user = usersDB.find(u => u.email === email && u.password === password);
                if (user) {
                    state.user = user;
                    localStorage.setItem('tg_user', JSON.stringify(state.user));
                    showError('');
                    updateAuthUI();
                } else {
                    showError('Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c.');
                }
            } else {
                // REGISTER LOGIC
                if (usersDB.find(u => u.email === email)) {
                    showError('Email n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω!');
                    return;
                }
                
                const newUser = { name, email, password };
                usersDB.push(newUser);
                localStorage.setItem('tg_users_db', JSON.stringify(usersDB));
                
                // Auto login
                state.user = newUser;
                localStorage.setItem('tg_user', JSON.stringify(state.user));
                showError('');
                updateAuthUI();
            }
        });
        
        document.getElementById('tab-register').addEventListener('click', () => {
            document.getElementById('field-name').classList.remove('hidden');
            document.getElementById('btn-auth-text').textContent = 'ƒêƒÉng K√Ω T√†i Kho·∫£n';
            document.getElementById('tab-register').className = "flex-1 py-2.5 rounded-lg text-sm font-medium transition-all bg-white/10 text-white shadow-lg";
            document.getElementById('tab-login').className = "flex-1 py-2.5 rounded-lg text-sm font-medium transition-all text-slate-500 hover:text-white";
            showError('');
        });
        
        document.getElementById('tab-login').addEventListener('click', () => {
            document.getElementById('field-name').classList.add('hidden');
            document.getElementById('btn-auth-text').textContent = 'Truy C·∫≠p H·ªá Th·ªëng';
            document.getElementById('tab-login').className = "flex-1 py-2.5 rounded-lg text-sm font-medium transition-all bg-white/10 text-white shadow-lg";
            document.getElementById('tab-register').className = "flex-1 py-2.5 rounded-lg text-sm font-medium transition-all text-slate-500 hover:text-white";
            showError('');
        });

        window.logout = function() {
            localStorage.removeItem('tg_user');
            state.user = null;
            updateAuthUI();
        };

        // Modal API Form
        document.getElementById('modal-api-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const key = document.getElementById('modal-input-key').value.trim();
            if(key) {
                if(initGemini(key)) {
                    document.getElementById('api-modal').classList.add('hidden');
                    addBotMessage("H·ªá th·ªëng Online. T√¥i ƒë√£ s·∫µn s√†ng h·ªó tr·ª£ b·∫°n!");
                } else {
                    alert("Key kh√¥ng h·ª£p l·ªá!");
                }
            }
        });

        // Profile API Form
        document.getElementById('profile-api-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const key = document.getElementById('profile-api-key').value.trim();
            if(key) {
                if(initGemini(key)) {
                    alert("ƒê√£ l∆∞u v√† k·∫øt n·ªëi th√†nh c√¥ng!");
                } else {
                    alert("K·∫øt n·ªëi th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i Key.");
                }
            }
        });

        // Search
        document.getElementById('search-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            const origin = document.getElementById('search-origin').value;
            const dest = document.getElementById('search-destination').value;
            const date = document.getElementById('search-date').value;
            const type = document.getElementById('search-type').value;

            // Deep Links Generation
            const container = document.getElementById('external-buttons-container');
            container.innerHTML = '';
            
            const btnClass = "px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 hover:-translate-y-1 shadow-md uppercase tracking-wider";
            
            // Google Link
            const googleLink = document.createElement('a');
            googleLink.target = "_blank";
            googleLink.className = `${btnClass} bg-white text-slate-900 hover:bg-slate-200`;
            googleLink.innerHTML = `<img src="https://www.google.com/favicon.ico" class="w-3 h-3"> Google Search`;
            
            if (type === 'Flight') googleLink.href = `https://www.google.com/search?q=v√©+m√°y+bay+${origin}+ƒëi+${dest}+${date}`;
            else if (type === 'Hotel') googleLink.href = `https://www.google.com/search?q=kh√°ch+s·∫°n+t·∫°i+${dest}+${date}`;
            else googleLink.href = `https://www.google.com/search?q=v√©+${type === 'Train'?'t√†u':'xe'}+${origin}+ƒëi+${dest}`;
            
            container.appendChild(googleLink);

            await new Promise(r => setTimeout(r, 2000)); // Fake delay
            
            // Render Tickets
            const tickets = generateTickets(type, origin, dest, date);
            const grid = document.getElementById('results-grid');
            grid.innerHTML = '';
            
            document.getElementById('res-origin').textContent = origin || 'ƒêi·ªÉm ƒëi';
            document.getElementById('res-destination').textContent = dest;
            document.getElementById('res-date').textContent = date;

            tickets.forEach(t => {
                const el = document.createElement('div');
                el.className = 'glass-panel rounded-2xl overflow-hidden flex flex-col group hover:-translate-y-2 hover:shadow-[0_10px_30px_rgba(168,85,247,0.2)] transition-all duration-300 border border-white/5 relative';
                el.innerHTML = `
                    <div class="h-32 bg-gradient-to-br from-indigo-900 to-purple-900 p-5 relative flex flex-col justify-end group-hover:from-indigo-800 group-hover:to-purple-800 transition-colors">
                        <div class="absolute top-4 right-4 px-2 py-1 bg-black/30 rounded text-[10px] font-mono text-white/70 border border-white/10">${t.provider}</div>
                        <p class="text-white font-bold text-lg relative z-10 tracking-tight">${t.time}</p>
                        <p class="text-white/60 text-xs relative z-10 font-mono">Direct Flight</p>
                    </div>
                    <div class="p-5 flex-1 flex flex-col justify-between bg-[#0a0a1a]">
                        <div class="mb-4">
                            <p class="text-xs text-slate-500 uppercase tracking-widest mb-1">Gi√° V√©</p>
                            <p class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">${t.price}</p>
                        </div>
                        <a href="${t.link}" target="_blank" class="block w-full text-center py-3 rounded-xl text-xs font-bold border border-cyan-500/30 text-cyan-400 hover:bg-cyan-500 hover:text-white transition-all uppercase tracking-widest hover:shadow-[0_0_15px_rgba(6,182,212,0.4)]">
                            ƒê·∫∑t Ngay
                        </a>
                    </div>
                `;
                grid.appendChild(el);
            });

            document.getElementById('loading-overlay').classList.add('hidden');
            navigateTo('results');
        });

        // Chat
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            // User UI
            const chatBox = document.getElementById('chat-messages');
            const userDiv = document.createElement('div');
            userDiv.className = 'flex items-start gap-4 flex-row-reverse animate-[fadeIn_0.3s]';
            userDiv.innerHTML = `
                <div class="w-10 h-10 rounded-xl bg-slate-800 border border-white/10 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="user" class="text-slate-400 w-5 h-5"></i>
                </div>
                <div class="glass-panel px-6 py-4 rounded-2xl rounded-tr-none max-w-[85%] text-sm leading-relaxed text-white border-purple-500/20 bg-purple-500/5">
                    ${text}
                </div>
            `;
            chatBox.appendChild(userDiv);
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
            lucide.createIcons();

            // Bot UI
            let reply = "";
            if (!state.isOffline && chatSession) {
                const loadingId = 'loading-' + Date.now();
                const loadDiv = document.createElement('div');
                loadDiv.id = loadingId;
                loadDiv.className = 'flex items-start gap-4 animate-pulse';
                loadDiv.innerHTML = `
                   <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-400/20 to-purple-500/20 flex items-center justify-center flex-shrink-0"><i data-lucide="loader" class="text-cyan-400 w-5 h-5 spin"></i></div>
                   <div class="glass-panel px-6 py-4 rounded-2xl rounded-tl-none w-32 h-12"></div>
                `;
                chatBox.appendChild(loadDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
                lucide.createIcons();

                try {
                    const result = await chatSession.sendMessage({ message: text });
                    reply = result.text;
                } catch(err) {
                    reply = "Xin l·ªói, k·∫øt n·ªëi AI b·ªã gi√°n ƒëo·∫°n. Vui l√≤ng ki·ªÉm tra l·∫°i Key ho·∫∑c th·ª≠ l·∫°i sau.";
                }
                document.getElementById(loadingId).remove();
            } else {
                // Offline Logic
                await new Promise(r => setTimeout(r, 500));
                const lower = text.toLowerCase();
                if(lower.includes('gi√°') || lower.includes('v√©')) reply = "B·∫°n vui l√≤ng d√πng t√≠nh nƒÉng 'Kh√°m Ph√°' ƒë·ªÉ xem gi√° v√© c·∫≠p nh·∫≠t t·ª´ Google nh√©.";
                else if(lower.includes('ch√†o')) reply = "Ch√†o b·∫°n! T√¥i ƒëang ·ªü ch·∫ø ƒë·ªô Offline. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m ki·∫øm chuy·∫øn ƒëi.";
                else reply = "T√¥i ƒëang offline n√™n ki·∫øn th·ª©c h·∫°n ch·∫ø. H√£y nh·∫≠p API Key trong ph·∫ßn H·ªì S∆° ƒë·ªÉ t√¥i th√¥ng minh h∆°n nh√©!";
            }

            const botDiv = document.createElement('div');
            botDiv.className = 'flex items-start gap-4 animate-[fadeIn_0.3s]';
            botDiv.innerHTML = `
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-400/20 to-purple-500/20 border border-white/10 flex items-center justify-center flex-shrink-0 shadow-[0_0_15px_rgba(168,85,247,0.2)]">
                    <i data-lucide="bot" class="text-cyan-400 w-5 h-5"></i>
                </div>
                <div class="glass-panel px-6 py-4 rounded-2xl rounded-tl-none max-w-[85%] text-sm leading-relaxed text-slate-200 shadow-lg">
                    ${reply.replace(/\n/g, '<br>')}
                </div>
            `;
            chatBox.appendChild(botDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            lucide.createIcons();
        });

        // Autocomplete
        function setupAutocomplete(inpId, listId) {
            const inp = document.getElementById(inpId);
            const list = document.getElementById(listId);
            
            inp.addEventListener('input', () => {
                const val = inp.value.toLowerCase();
                list.innerHTML = '';
                if(!val) { list.classList.add('hidden'); return; }
                const filtered = LOCATIONS.filter(l => l.toLowerCase().includes(val));
                if(filtered.length === 0) { list.classList.add('hidden'); return; }
                
                list.classList.remove('hidden');
                filtered.forEach(loc => {
                    const d = document.createElement('div');
                    d.className = 'autocomplete-item';
                    d.textContent = loc;
                    d.onclick = () => { inp.value = loc; list.classList.add('hidden'); };
                    list.appendChild(d);
                });
            });
            document.addEventListener('click', e => {
                if(e.target !== inp && e.target !== list) list.classList.add('hidden');
            });
        }

        // Init
        (function() {
            lucide.createIcons();
            
            // 1. Check Gatekeeper (API Key)
            checkGatekeeper();

            // 2. Check User Session
            const storedUser = localStorage.getItem('tg_user');
            if(storedUser) {
                state.user = JSON.parse(storedUser);
                updateAuthUI();
            } else {
                updateAuthUI();
            }
            
            setupAutocomplete('search-origin', 'suggestions-origin');
            setupAutocomplete('search-destination', 'suggestions-destination');
            document.getElementById('search-date').valueAsDate = new Date();
        })();
    </script>
</body>
</html>
