<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelGenie AI - Du Lịch Thông Minh</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #ffffff;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-gradient-animate {
            background: linear-gradient(-45deg, #1e1b4b, #312e81, #0f172a, #4c1d95);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 10px 30px -10px rgba(139, 92, 246, 0.3);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }

        .glass-input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
            background: rgba(15, 23, 42, 0.8);
        }

        /* Autocomplete Dropdown */
        .autocomplete-items {
            position: absolute;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 0 12px 12px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.875rem;
            color: #cbd5e1;
        }
        .autocomplete-item:hover {
            background-color: rgba(139, 92, 246, 0.2);
            color: #ffffff;
        }
        .autocomplete-active {
            background-color: rgba(139, 92, 246, 0.4) !important;
            color: #ffffff;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #8b5cf6;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Background -->
    <div class="bg-gradient-animate"></div>

    <!-- Auth View (Login/Register) -->
    <section id="view-auth" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="glass w-full max-w-md p-8 rounded-3xl shadow-2xl border-t border-white/10 relative overflow-hidden">
            <!-- Background Glow -->
            <div class="absolute -top-20 -right-20 w-40 h-40 bg-purple-500/30 rounded-full blur-3xl pointer-events-none"></div>
            <div class="absolute -bottom-20 -left-20 w-40 h-40 bg-cyan-500/30 rounded-full blur-3xl pointer-events-none"></div>

            <div class="relative z-10">
                <div class="flex flex-col items-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-tr from-cyan-400 to-purple-600 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-purple-500/30">
                        <i data-lucide="plane" class="w-8 h-8 text-white"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-cyan-300 to-purple-300">TravelGenie AI</h1>
                    <p class="text-slate-400 text-center mt-2 text-sm">Đồng hành cùng bạn trên mọi nẻo đường</p>
                </div>

                <!-- Tabs -->
                <div class="flex bg-slate-800/50 rounded-xl p-1 mb-6">
                    <button id="tab-login" class="flex-1 py-2 rounded-lg text-sm font-medium bg-white/10 text-white shadow-sm transition-all">Đăng Nhập</button>
                    <button id="tab-register" class="flex-1 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white transition-all">Đăng Ký</button>
                </div>

                <!-- Login Form -->
                <form id="form-login" class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Email</label>
                        <input type="email" id="login-email" placeholder="email@example.com" required 
                            class="w-full glass-input px-4 py-3 rounded-xl text-sm placeholder-slate-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Mật khẩu</label>
                        <input type="password" id="login-password" placeholder="••••••••" required 
                            class="w-full glass-input px-4 py-3 rounded-xl text-sm placeholder-slate-500">
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg shadow-cyan-500/25 mt-2">
                        Đăng Nhập
                    </button>
                </form>

                <!-- Register Form -->
                <form id="form-register" class="space-y-4 hidden">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Họ và Tên</label>
                        <input type="text" id="reg-name" placeholder="Nguyễn Văn A" required 
                            class="w-full glass-input px-4 py-3 rounded-xl text-sm placeholder-slate-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Email</label>
                        <input type="email" id="reg-email" placeholder="email@example.com" required 
                            class="w-full glass-input px-4 py-3 rounded-xl text-sm placeholder-slate-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Mật khẩu</label>
                        <input type="password" id="reg-password" placeholder="••••••••" required 
                            class="w-full glass-input px-4 py-3 rounded-xl text-sm placeholder-slate-500">
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg shadow-purple-500/25 mt-2">
                        Tạo Tài Khoản
                    </button>
                </form>

                <p id="auth-error" class="text-red-400 text-xs text-center mt-4 hidden"></p>
            </div>
        </div>
    </section>

    <!-- App Container -->
    <div id="app" class="relative min-h-screen flex flex-col hidden">
        
        <!-- Navbar -->
        <nav class="sticky top-0 z-40 w-full glass border-b border-white/5">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <!-- Logo -->
                    <div class="flex items-center gap-2 cursor-pointer" onclick="window.navigateTo('home')">
                        <div class="w-8 h-8 bg-gradient-to-br from-cyan-400 to-purple-500 rounded-lg flex items-center justify-center">
                            <i data-lucide="plane" class="w-5 h-5 text-white"></i>
                        </div>
                        <span class="font-bold text-xl tracking-tight">TravelGenie</span>
                    </div>

                    <!-- Desktop Menu -->
                    <div class="hidden md:flex items-center space-x-8">
                        <a href="#" onclick="window.navigateTo('home')" class="nav-link text-sm font-medium text-white hover:text-cyan-400 transition-colors">Tìm kiếm</a>
                        <a href="#" onclick="window.navigateTo('chat')" class="nav-link text-sm font-medium text-slate-300 hover:text-cyan-400 transition-colors">Trợ lý AI</a>
                        <a href="#" onclick="window.navigateTo('profile')" class="nav-link text-sm font-medium text-slate-300 hover:text-cyan-400 transition-colors">Hồ sơ</a>
                    </div>

                    <!-- Mobile Menu Button & User -->
                    <div class="flex items-center gap-4">
                        <div id="user-indicator" class="hidden md:flex items-center gap-2 px-3 py-1.5 glass rounded-full border border-white/10">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span id="nav-username" class="text-xs font-medium text-slate-300">Khách</span>
                        </div>
                        <button class="md:hidden text-slate-300 hover:text-white">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-grow relative">
            
            <!-- VIEW: HOME (Search) -->
            <section id="view-home" class="view-section px-4 pt-10 pb-20">
                <div class="max-w-4xl mx-auto text-center mb-12">
                    <h1 class="text-4xl md:text-6xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-cyan-300 via-purple-300 to-pink-300">
                        Bạn muốn đi đâu tiếp theo?
                    </h1>
                    <p class="text-lg text-slate-400 max-w-2xl mx-auto">
                        Tìm kiếm vé máy bay, tàu hỏa, xe buýt và khách sạn theo thời gian thực cùng AI.
                    </p>
                </div>

                <!-- Search Box -->
                <div class="max-w-5xl mx-auto glass p-6 md:p-8 rounded-3xl shadow-2xl border border-white/10 relative overflow-visible">
                    <!-- Glow effect behind -->
                    <div class="absolute -top-20 -right-20 w-64 h-64 bg-purple-500/20 rounded-full blur-3xl pointer-events-none"></div>
                    <div class="absolute -bottom-20 -left-20 w-64 h-64 bg-cyan-500/20 rounded-full blur-3xl pointer-events-none"></div>

                    <form id="search-form" class="relative z-10 grid grid-cols-1 md:grid-cols-12 gap-4">
                        
                        <!-- Type -->
                        <div class="md:col-span-2 group">
                            <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Loại hình</label>
                            <div class="relative">
                                <i data-lucide="layers" class="absolute left-3 top-3 w-5 h-5 text-slate-500 group-focus-within:text-pink-400 transition-colors z-10"></i>
                                <select id="input-type" class="w-full glass-input pl-10 pr-4 py-3 rounded-xl text-sm focus:ring-0 appearance-none cursor-pointer relative z-0">
                                    <option value="Flight" class="bg-slate-800">Máy Bay</option>
                                    <option value="Train" class="bg-slate-800">Tàu Hỏa</option>
                                    <option value="Bus" class="bg-slate-800">Xe Buýt</option>
                                    <option value="Hotel" class="bg-slate-800">Khách Sạn</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-slate-500 pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Origin (Hidden if Hotel) -->
                        <div class="md:col-span-3 group transition-all duration-300" id="field-origin">
                            <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Điểm đi</label>
                            <div class="relative autocomplete">
                                <i data-lucide="map-pin" class="absolute left-3 top-3 w-5 h-5 text-slate-500 group-focus-within:text-cyan-400 transition-colors"></i>
                                <input type="text" id="input-origin" placeholder="Hà Nội, HCM..." 
                                    class="w-full glass-input pl-10 pr-4 py-3 rounded-xl text-sm focus:ring-0" autocomplete="off">
                                <!-- Suggestions rendered via JS -->
                            </div>
                        </div>

                        <!-- Destination -->
                        <div class="md:col-span-3 group transition-all duration-300" id="field-destination">
                            <label class="block text-xs font-medium text-slate-400 mb-1 ml-1" id="label-destination">Điểm đến</label>
                            <div class="relative autocomplete">
                                <i data-lucide="navigation" class="absolute left-3 top-3 w-5 h-5 text-slate-500 group-focus-within:text-purple-400 transition-colors"></i>
                                <input type="text" id="input-destination" placeholder="Đà Nẵng, Nha Trang..." required
                                    class="w-full glass-input pl-10 pr-4 py-3 rounded-xl text-sm focus:ring-0" autocomplete="off">
                                <!-- Suggestions rendered via JS -->
                            </div>
                        </div>

                        <!-- Date -->
                        <div class="md:col-span-2 group">
                            <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Ngày</label>
                            <div class="relative">
                                <input type="date" id="input-date" required
                                    class="w-full glass-input px-4 py-3 rounded-xl text-sm focus:ring-0 appearance-none text-slate-300">
                            </div>
                        </div>

                        <!-- Button -->
                        <div class="md:col-span-2 flex items-end" id="field-button">
                            <button type="submit" id="btn-search" 
                                class="w-full h-[46px] bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white font-semibold rounded-xl transition-all shadow-lg shadow-cyan-500/20 flex items-center justify-center gap-2 group">
                                <span class="group-hover:hidden">Tìm Kiếm</span>
                                <span class="hidden group-hover:inline">Đi Thôi</span>
                                <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Features Grid (Decorative) -->
                <div class="max-w-6xl mx-auto mt-20 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass p-6 rounded-2xl border border-white/5">
                        <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center mb-4 text-purple-400">
                            <i data-lucide="zap" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">AI Thông Minh</h3>
                        <p class="text-slate-400 text-sm">Tự động tìm đường bay nối chuyến hoặc kết hợp xe khách nếu điểm đến không có sân bay.</p>
                    </div>
                    <div class="glass p-6 rounded-2xl border border-white/5">
                        <div class="w-10 h-10 rounded-full bg-pink-500/20 flex items-center justify-center mb-4 text-pink-400">
                            <i data-lucide="heart" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Cá Nhân Hóa</h3>
                        <p class="text-slate-400 text-sm">Học hỏi sở thích để gợi ý những chuyến đi và khách sạn phù hợp nhất.</p>
                    </div>
                    <div class="glass p-6 rounded-2xl border border-white/5">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center mb-4 text-cyan-400">
                            <i data-lucide="shield-check" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Nguồn Tin Cậy</h3>
                        <p class="text-slate-400 text-sm">Dữ liệu minh bạch, liên kết trực tiếp đến nhà cung cấp dịch vụ.</p>
                    </div>
                </div>
            </section>

            <!-- VIEW: LOADING -->
            <section id="view-loading" class="view-section hidden absolute inset-0 flex flex-col items-center justify-center z-50 bg-slate-900/50 backdrop-blur-sm min-h-[500px]">
                <div class="relative">
                    <div class="w-20 h-20 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"></div>
                    <div class="absolute top-0 left-0 w-20 h-20 border-4 border-purple-500/30 border-b-purple-500 rounded-full animate-spin" style="animation-direction: reverse; animation-duration: 1.5s;"></div>
                    <i data-lucide="plane" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-6 h-6 text-white animate-pulse"></i>
                </div>
                <h3 class="mt-8 text-xl font-medium text-white">Đang phân tích lộ trình...</h3>
                <p id="loading-text" class="text-slate-400 mt-2 text-sm">Gemini đang tìm kiếm chuyến đi tốt nhất cho bạn</p>
            </section>

            <!-- VIEW: SEARCH RESULTS -->
            <section id="view-results" class="view-section hidden px-4 py-8">
                <div class="max-w-6xl mx-auto">
                    <!-- Results Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                        <div>
                            <button onclick="window.navigateTo('home')" class="flex items-center text-slate-400 hover:text-white mb-2 transition-colors">
                                <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Quay lại tìm kiếm
                            </button>
                            <h2 class="text-2xl font-bold flex items-center gap-2">
                                <span id="res-origin" class="text-slate-300">Điểm đi</span>
                                <i data-lucide="arrow-right" class="w-5 h-5 text-slate-500"></i>
                                <span id="res-destination" class="text-cyan-400">Điểm đến</span>
                            </h2>
                            <p class="text-sm text-slate-400 mt-1 flex items-center gap-2">
                                <i data-lucide="calendar" class="w-3 h-3"></i> <span id="res-date">Ngày</span>
                                <span class="mx-1">•</span>
                                <span id="res-count">0 kết quả tìm thấy</span>
                            </p>
                        </div>
                        
                        <div class="flex gap-2">
                            <button class="px-4 py-2 glass rounded-lg text-sm hover:bg-white/5 transition-colors">Rẻ nhất</button>
                            <button class="px-4 py-2 bg-white/10 text-white rounded-lg text-sm border border-cyan-500/50">Nhanh nhất</button>
                        </div>
                    </div>

                    <!-- Results Grid -->
                    <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Cards will be injected here via JS -->
                    </div>

                    <!-- Data Sources -->
                    <div class="mt-12 p-6 glass rounded-2xl border border-white/5">
                        <h4 class="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2">
                            <i data-lucide="link" class="w-4 h-4"></i> Nguồn Dữ Liệu
                        </h4>
                        <div id="sources-list" class="flex flex-wrap gap-2 text-xs text-slate-500">
                            <!-- Links injected here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: AI CHAT -->
            <section id="view-chat" class="view-section hidden h-[calc(100vh-64px)] flex flex-col">
                <div class="flex-1 overflow-y-auto p-4 space-y-4 max-w-4xl mx-auto w-full" id="chat-messages">
                    <!-- Welcome Message -->
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-cyan-500 to-blue-500 flex-shrink-0 flex items-center justify-center">
                            <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                        </div>
                        <div class="glass p-4 rounded-2xl rounded-tl-none max-w-[80%] text-sm text-slate-200">
                            Xin chào! Tôi là trợ lý du lịch AI của bạn. Hãy hỏi tôi về địa điểm, thủ tục visa, hoặc danh sách đồ cần chuẩn bị cho chuyến đi sắp tới nhé!
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="p-4 border-t border-white/10 glass bg-slate-900/80">
                    <form id="chat-form" class="max-w-4xl mx-auto relative flex gap-2">
                        <input type="text" id="chat-input" placeholder="Hỏi Gemini..." 
                            class="flex-1 glass-input px-4 py-3 rounded-xl focus:ring-0 text-sm">
                        <button type="submit" class="bg-cyan-600 hover:bg-cyan-500 text-white p-3 rounded-xl transition-colors">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
            </section>

            <!-- VIEW: PROFILE (Real Data) -->
            <section id="view-profile" class="view-section hidden px-4 py-10">
                <div class="max-w-2xl mx-auto glass rounded-3xl p-8 border border-white/10 text-center">
                    <div class="w-24 h-24 bg-gradient-to-br from-pink-500 to-orange-400 rounded-full mx-auto mb-4 p-1">
                        <img src="https://picsum.photos/200" alt="Avatar" class="w-full h-full rounded-full border-4 border-slate-900 object-cover">
                    </div>
                    <h2 id="profile-name" class="text-2xl font-bold text-white">User Name</h2>
                    <p id="profile-email" class="text-slate-400 text-sm mb-6">user@example.com</p>
                    
                    <div class="grid grid-cols-2 gap-4 text-left mb-8">
                        <div class="glass p-4 rounded-xl">
                            <p class="text-xs text-slate-500 uppercase">Chuyến đi</p>
                            <p class="text-2xl font-bold text-cyan-400">0</p>
                        </div>
                        <div class="glass p-4 rounded-xl">
                            <p class="text-xs text-slate-500 uppercase">Đã lưu</p>
                            <p class="text-2xl font-bold text-purple-400">0</p>
                        </div>
                    </div>
                    
                    <button id="btn-logout" class="w-full py-3 glass rounded-xl text-red-400 hover:bg-red-500/10 transition-colors text-sm font-medium">
                        Đăng Xuất
                    </button>
                </div>
            </section>

        </main>
    </div>

    <!-- MAIN SCRIPT -->
    <script type="module">
        import { GoogleGenAI } from "https://esm.run/@google/genai";

        // --- CONSTANTS & CONFIG ---
        const API_KEYS = [
            "AIzaSyDpiZ8LHJNPXd1VgtHFV7luhc5cbIt3cnM",
            "AIzaSyB78pNkaqTKqa_hZtruMGOHsFzwam58b-g",
            "AIzaSyAKPPl5zj0XxqACNbJX-wYlkmCTiLVQkuE"
        ];
        let currentKeyIndex = 0;

        const CITY_IMAGES = {
            "Hanoi": "https://images.unsplash.com/photo-1555921015-5532091f6026?auto=format&fit=crop&w=800&q=80",
            "Ha Noi": "https://images.unsplash.com/photo-1555921015-5532091f6026?auto=format&fit=crop&w=800&q=80",
            "Hà Nội": "https://images.unsplash.com/photo-1555921015-5532091f6026?auto=format&fit=crop&w=800&q=80",
            "Ho Chi Minh": "https://images.unsplash.com/photo-1583417319070-4a69db38a482?auto=format&fit=crop&w=800&q=80",
            "Saigon": "https://images.unsplash.com/photo-1583417319070-4a69db38a482?auto=format&fit=crop&w=800&q=80",
            "Hồ Chí Minh": "https://images.unsplash.com/photo-1583417319070-4a69db38a482?auto=format&fit=crop&w=800&q=80",
            "Da Nang": "https://images.unsplash.com/photo-1559592413-7cec4d0cae2b?auto=format&fit=crop&w=800&q=80",
            "Danang": "https://images.unsplash.com/photo-1559592413-7cec4d0cae2b?auto=format&fit=crop&w=800&q=80",
            "Đà Nẵng": "https://images.unsplash.com/photo-1559592413-7cec4d0cae2b?auto=format&fit=crop&w=800&q=80",
            "Sapa": "https://images.unsplash.com/photo-1534057357497-69502b48995a?auto=format&fit=crop&w=800&q=80",
            "Hoi An": "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=800&q=80",
            "Hội An": "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=800&q=80",
            "Phu Quoc": "https://images.unsplash.com/photo-1588665046200-c943891d4576?auto=format&fit=crop&w=800&q=80",
            "Phú Quốc": "https://images.unsplash.com/photo-1588665046200-c943891d4576?auto=format&fit=crop&w=800&q=80",
            "Ha Long": "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=800&q=80",
            "Halong": "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=800&q=80",
            "Hạ Long": "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=800&q=80",
            "Nha Trang": "https://images.unsplash.com/photo-1565620958189-e962657e3352?auto=format&fit=crop&w=800&q=80",
            "Can Tho": "https://images.unsplash.com/photo-1580587771525-78b9dba3b91d?auto=format&fit=crop&w=800&q=80",
            "Cần Thơ": "https://images.unsplash.com/photo-1580587771525-78b9dba3b91d?auto=format&fit=crop&w=800&q=80",
            "Ca Mau": "https://images.unsplash.com/photo-1580587771525-78b9dba3b91d?auto=format&fit=crop&w=800&q=80",
            "Cà Mau": "https://images.unsplash.com/photo-1580587771525-78b9dba3b91d?auto=format&fit=crop&w=800&q=80",
            "default": "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?auto=format&fit=crop&w=800&q=80"
        };

        const VIETNAM_LOCATIONS = [
            "Hà Nội (HAN)", "Hồ Chí Minh (SGN)", "Đà Nẵng (DAD)", "Hải Phòng (HPH)", "Cần Thơ (VCA)", 
            "Phú Quốc (PQC)", "Nha Trang (CXR)", "Đà Lạt (DLI)", "Huế (HUI)", "Vinh (VII)", "Thanh Hóa (THD)",
            "Đồng Hới (VDH)", "Chu Lai (VCL)", "Tuy Hòa (TBB)", "Quy Nhơn (UIH)", "Buôn Ma Thuột (BMV)",
            "Pleiku (PXU)", "Côn Đảo (VCS)", "Điện Biên Phủ (DIN)", "Rạch Giá (VKG)", "Cà Mau (CAH)",
            "Hải Dương", "Hưng Yên", "Nam Định", "Ninh Bình", "Thái Bình", "Vĩnh Phúc", "Hà Giang", 
            "Cao Bằng", "Bắc Kạn", "Lạng Sơn", "Tuyên Quang", "Thái Nguyên", "Phú Thọ", "Bắc Giang", 
            "Quảng Ninh", "Sapa (Lào Cai)", "Sơn La", "Hòa Bình", "Nghệ An", "Hà Tĩnh", "Quảng Bình", 
            "Quảng Trị", "Quảng Nam (Hội An)", "Quảng Ngãi", "Bình Định", "Phú Yên", "Khánh Hòa", 
            "Ninh Thuận", "Bình Thuận", "Kon Tum", "Gia Lai", "Đắk Lắk", "Đắk Nông", "Lâm Đồng", 
            "Bình Phước", "Tây Ninh", "Bình Dương", "Đồng Nai", "Bà Rịa - Vũng Tàu", "Long An", 
            "Tiền Giang", "Bến Tre", "Trà Vinh", "Vĩnh Long", "Đồng Tháp", "An Giang", "Kiên Giang", 
            "Hậu Giang", "Sóc Trăng", "Bạc Liêu"
        ];

        // --- STATE MANAGEMENT ---
        const state = {
            currentUser: null,
            currentView: 'home',
            searchData: null,
            searchResults: []
        };

        // --- DOM ELEMENTS ---
        const elements = {
            app: document.getElementById('app'),
            viewAuth: document.getElementById('view-auth'),
            
            // Auth Elements
            tabLogin: document.getElementById('tab-login'),
            tabRegister: document.getElementById('tab-register'),
            formLogin: document.getElementById('form-login'),
            formRegister: document.getElementById('form-register'),
            authError: document.getElementById('auth-error'),
            
            // Main Views
            views: {
                home: document.getElementById('view-home'),
                results: document.getElementById('view-results'),
                chat: document.getElementById('view-chat'),
                profile: document.getElementById('view-profile'),
                loading: document.getElementById('view-loading')
            },
            
            // Search Form
            searchForm: document.getElementById('search-form'),
            inputType: document.getElementById('input-type'),
            fieldOrigin: document.getElementById('field-origin'),
            inputOrigin: document.getElementById('input-origin'),
            fieldDestination: document.getElementById('field-destination'),
            labelDestination: document.getElementById('label-destination'),
            inputDestination: document.getElementById('input-destination'),
            fieldButton: document.getElementById('field-button'),
            inputDate: document.getElementById('input-date'),
            
            // Results & Chat
            resultsContainer: document.getElementById('results-container'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            chatMessages: document.getElementById('chat-messages'),
            resOrigin: document.getElementById('res-origin'),
            resDest: document.getElementById('res-destination'),
            resDate: document.getElementById('res-date'),
            resCount: document.getElementById('res-count'),
            sourcesList: document.getElementById('sources-list'),
            
            // Profile Info
            profileName: document.getElementById('profile-name'),
            profileEmail: document.getElementById('profile-email'),
            navUsername: document.getElementById('nav-username'),
            btnLogout: document.getElementById('btn-logout')
        };

        // --- GENAI WRAPPER (AUTO ROTATION) ---
        async function callGeminiSafe(params) {
            let lastError = null;
            
            for (let i = 0; i < API_KEYS.length; i++) {
                const tryIndex = (currentKeyIndex + i) % API_KEYS.length;
                const apiKey = API_KEYS[tryIndex];
                
                try {
                    const ai = new GoogleGenAI({ apiKey: apiKey });
                    const response = await ai.models.generateContent(params);
                    currentKeyIndex = tryIndex;
                    return response;
                } catch (error) {
                    console.warn(`Key ...${apiKey.slice(-4)} failed (Index: ${tryIndex}). Trying next...`, error);
                    lastError = error;
                }
            }
            throw lastError;
        }

        // --- AUTH LOGIC ---
        function loadUsers() {
            const users = localStorage.getItem('tg_users');
            return users ? JSON.parse(users) : [];
        }

        function saveUser(user) {
            const users = loadUsers();
            users.push(user);
            localStorage.setItem('tg_users', JSON.stringify(users));
        }

        function findUser(email) {
            const users = loadUsers();
            return users.find(u => u.email === email);
        }

        function login(email, password) {
            const user = findUser(email);
            if (user && user.password === password) {
                state.currentUser = user;
                localStorage.setItem('tg_current_user', JSON.stringify(user));
                updateAuthUI();
                return true;
            }
            return false;
        }

        function logout() {
            state.currentUser = null;
            localStorage.removeItem('tg_current_user');
            updateAuthUI();
        }

        function updateAuthUI() {
            if (state.currentUser) {
                elements.viewAuth.classList.add('hidden');
                elements.app.classList.remove('hidden');
                elements.navUsername.textContent = state.currentUser.name;
                elements.profileName.textContent = state.currentUser.name;
                elements.profileEmail.textContent = state.currentUser.email;
                window.navigateTo('home');
            } else {
                elements.viewAuth.classList.remove('hidden');
                elements.app.classList.add('hidden');
            }
        }

        // --- NAVIGATION ---
        window.navigateTo = function(viewName) {
            // Hide all views
            Object.values(elements.views).forEach(el => el.classList.add('hidden'));
            
            // Show target view
            if (elements.views[viewName]) {
                elements.views[viewName].classList.remove('hidden');
                state.currentView = viewName;
                
                // Active state for nav links (simple implementation)
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('text-cyan-400', 'text-white');
                    link.classList.add('text-slate-300');
                });
            }
            lucide.createIcons();
        };

        // --- SEARCH LOGIC ---
        function handleTypeChange() {
            const type = elements.inputType.value;
            const destInput = elements.inputDestination;
            
            if (type === 'Hotel') {
                elements.fieldOrigin.classList.add('hidden', 'md:hidden');
                // Expand Destination to fill space
                elements.fieldDestination.classList.remove('md:col-span-3');
                elements.fieldDestination.classList.add('md:col-span-6');
                
                elements.labelDestination.textContent = "Bạn muốn ở đâu?";
                destInput.placeholder = "Tên thành phố, khu vực...";
            } else {
                elements.fieldOrigin.classList.remove('hidden', 'md:hidden');
                elements.fieldDestination.classList.remove('md:col-span-6');
                elements.fieldDestination.classList.add('md:col-span-3');
                
                elements.labelDestination.textContent = "Điểm đến";
                destInput.placeholder = "Đà Nẵng, Nha Trang...";
            }
        }

        function setupAutocomplete(inp) {
            let currentFocus;
            inp.addEventListener("input", function(e) {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false; }
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);
                
                let count = 0;
                for (i = 0; i < VIETNAM_LOCATIONS.length; i++) {
                    if (VIETNAM_LOCATIONS[i].toUpperCase().includes(val.toUpperCase()) && count < 6) {
                        b = document.createElement("DIV");
                        b.setAttribute("class", "autocomplete-item");
                        b.innerHTML = "<strong>" + VIETNAM_LOCATIONS[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += VIETNAM_LOCATIONS[i].substr(val.length);
                        b.innerHTML += "<input type='hidden' value='" + VIETNAM_LOCATIONS[i] + "'>";
                        b.addEventListener("click", function(e) {
                            inp.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        a.appendChild(b);
                        count++;
                    }
                }
            });
            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        function getCityImage(city) {
            // Simple normalization to match keys
            for (const key in CITY_IMAGES) {
                if (city.toLowerCase().includes(key.toLowerCase())) {
                    return CITY_IMAGES[key];
                }
            }
            return CITY_IMAGES['default'];
        }

        async function searchRealTimeTickets(origin, destination, date, type) {
            const isHotel = type === 'Hotel';
            
            let systemInstruction = `
            You are a travel booking engine API that outputs ONLY raw JSON.
            Task: Search for real-time ${type} options ${isHotel ? `in ${destination}` : `from ${origin} to ${destination}`} on ${date}.
            
            IMPORTANT RULES:
            1. Return a JSON array. Each object must have: provider, time (departure/arrival or check-in/out), price (in VND), rating (1-5), link (booking url), and type.
            2. If ${type} is 'Flight' and the destination '${destination}' does NOT have a commercial airport or is difficult to reach directly:
               - You MUST suggest a "Combo" route: Flight to the nearest major airport + Bus/Taxi to final destination.
               - In the 'provider' field, write something like: "Vietnam Airlines + Xe Khách Phương Trang".
               - In the 'type' field, write: "Flight + Bus".
               - Clearly explain the route in a 'notes' field if necessary.
            3. Use the Google Search tool to find REAL prices and schedules for ${date}.
            4. Do not wrap the JSON in markdown code blocks. Just raw JSON.
            `;

            const prompt = `Find 5 best ${type} options. ${isHotel ? `Location: ${destination}` : `Route: ${origin} -> ${destination}`}. Date: ${date}. Currency: VND.`;

            try {
                const result = await callGeminiSafe({
                    model: "gemini-2.5-flash",
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    config: {
                        systemInstruction: systemInstruction,
                        tools: [{ googleSearch: {} }]
                    }
                });

                // Extract data
                const groundingChunks = result.candidates?.[0]?.groundingMetadata?.groundingChunks || [];
                const sources = groundingChunks
                    .map(c => c.web?.uri ? `<a href="${c.web.uri}" target="_blank" class="hover:text-cyan-400 underline">${c.web.title || 'Source'}</a>` : '')
                    .filter(Boolean);

                let jsonText = result.response.text.trim();
                // Clean up markdown if present
                if (jsonText.startsWith('```json')) {
                    jsonText = jsonText.replace(/^```json\n/, '').replace(/\n```$/, '');
                } else if (jsonText.startsWith('```')) {
                    jsonText = jsonText.replace(/^```\n/, '').replace(/\n```$/, '');
                }

                const tickets = JSON.parse(jsonText);
                return { tickets, sources };

            } catch (error) {
                console.error("Search Error:", error);
                throw error;
            }
        }

        // --- UI RENDERING ---
        function renderResults(data, origin, destination, date, type) {
            elements.resultsContainer.innerHTML = '';
            elements.sourcesList.innerHTML = data.sources.join(' • ') || 'Dữ liệu tổng hợp từ AI';
            
            elements.resOrigin.textContent = type === 'Hotel' ? 'Khách sạn tại' : origin;
            elements.resDest.textContent = destination;
            elements.resDate.textContent = date;
            elements.resCount.textContent = `${data.tickets.length} kết quả`;

            const destImage = getCityImage(destination);

            data.tickets.forEach(ticket => {
                const card = document.createElement('div');
                card.className = 'glass-card rounded-2xl overflow-hidden flex flex-col';
                
                const isCombo = ticket.type && ticket.type.includes('+');
                
                card.innerHTML = `
                    <div class="h-32 bg-cover bg-center relative" style="background-image: url('${destImage}')">
                        <div class="absolute inset-0 bg-black/40"></div>
                        <div class="absolute bottom-3 left-4 text-white">
                            <p class="text-xs font-bold bg-cyan-500/80 px-2 py-1 rounded mb-1 w-max">${ticket.provider}</p>
                            <p class="text-xs opacity-80">${ticket.time}</p>
                        </div>
                        ${isCombo ? '<div class="absolute top-3 right-3 bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded shadow-lg">Combo Đa Chặng</div>' : ''}
                    </div>
                    <div class="p-4 flex-grow flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg text-white">${ticket.type || type}</h3>
                                <div class="flex items-center text-yellow-400 text-xs gap-1">
                                    <i data-lucide="star" class="w-3 h-3 fill-current"></i>
                                    <span>${ticket.rating || '4.5'}</span>
                                </div>
                            </div>
                            <p class="text-2xl font-bold text-cyan-400 mb-4">${ticket.price}</p>
                            ${ticket.notes ? `<p class="text-xs text-slate-400 mb-3 bg-white/5 p-2 rounded">${ticket.notes}</p>` : ''}
                        </div>
                        <a href="${ticket.link || '#'}" target="_blank" class="block w-full text-center py-2 rounded-xl bg-white/10 hover:bg-white/20 text-white font-medium transition-colors">Đặt Ngay</a>
                    </div>
                `;
                elements.resultsContainer.appendChild(card);
            });
            lucide.createIcons();
            window.navigateTo('results');
        }

        // --- CHAT LOGIC ---
        async function handleChat(e) {
            e.preventDefault();
            const message = elements.chatInput.value.trim();
            if (!message) return;

            // Add User Message
            appendMessage('user', message);
            elements.chatInput.value = '';

            try {
                // Add Loading Message
                const loadingId = appendMessage('ai', 'Đang nhập...', true);

                const result = await callGeminiSafe({
                    model: "gemini-2.5-flash",
                    contents: [{ role: "user", parts: [{ text: message }] }]
                });

                const response = result.response.text;
                
                // Remove loading, add real message
                document.getElementById(loadingId).remove();
                appendMessage('ai', response);

            } catch (error) {
                console.error(error);
                appendMessage('ai', "Xin lỗi, tôi đang gặp sự cố kết nối.");
            }
        }

        function appendMessage(role, text, isLoading = false) {
            const div = document.createElement('div');
            div.className = `flex items-start gap-3 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            if (isLoading) div.id = 'msg-' + Date.now();

            const avatar = role === 'ai' 
                ? `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-cyan-500 to-blue-500 flex-shrink-0 flex items-center justify-center"><i data-lucide="bot" class="w-5 h-5 text-white"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-slate-700 flex-shrink-0 flex items-center justify-center"><i data-lucide="user" class="w-5 h-5 text-white"></i></div>`;

            div.innerHTML = `
                ${avatar}
                <div class="glass p-4 rounded-2xl ${role === 'user' ? 'rounded-tr-none bg-cyan-900/30' : 'rounded-tl-none'} max-w-[80%] text-sm text-slate-200">
                    ${isLoading ? '<div class="flex gap-1"><span class="w-1 h-1 bg-white rounded-full animate-bounce"></span><span class="w-1 h-1 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></span><span class="w-1 h-1 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></span></div>' : text}
                </div>
            `;
            elements.chatMessages.appendChild(div);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            lucide.createIcons();
            return div.id;
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Init Icons
            lucide.createIcons();
            
            // Check Auth
            const storedUser = localStorage.getItem('tg_current_user');
            if (storedUser) {
                state.currentUser = JSON.parse(storedUser);
                updateAuthUI();
            }

            // Set Date to Today
            elements.inputDate.valueAsDate = new Date();

            // Autocomplete Setup
            setupAutocomplete(elements.inputOrigin);
            setupAutocomplete(elements.inputDestination);

            // Auth Tabs
            elements.tabLogin.addEventListener('click', () => {
                elements.tabLogin.classList.replace('text-slate-400', 'text-white');
                elements.tabLogin.classList.add('bg-white/10');
                elements.tabRegister.classList.replace('text-white', 'text-slate-400');
                elements.tabRegister.classList.remove('bg-white/10');
                elements.formLogin.classList.remove('hidden');
                elements.formRegister.classList.add('hidden');
                elements.authError.classList.add('hidden');
            });

            elements.tabRegister.addEventListener('click', () => {
                elements.tabRegister.classList.replace('text-slate-400', 'text-white');
                elements.tabRegister.classList.add('bg-white/10');
                elements.tabLogin.classList.replace('text-white', 'text-slate-400');
                elements.tabLogin.classList.remove('bg-white/10');
                elements.formRegister.classList.remove('hidden');
                elements.formLogin.classList.add('hidden');
                elements.authError.classList.add('hidden');
            });

            // Auth Submit
            elements.formLogin.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-password').value;
                if (!login(email, pass)) {
                    elements.authError.textContent = "Email hoặc mật khẩu không đúng!";
                    elements.authError.classList.remove('hidden');
                }
            });

            elements.formRegister.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value;
                const pass = document.getElementById('reg-password').value;
                
                if (findUser(email)) {
                    elements.authError.textContent = "Email đã tồn tại!";
                    elements.authError.classList.remove('hidden');
                    return;
                }

                saveUser({ name, email, password: pass });
                login(email, pass);
            });

            // Logout
            elements.btnLogout.addEventListener('click', logout);

            // Search Type Change
            elements.inputType.addEventListener('change', handleTypeChange);
            handleTypeChange(); // Init state

            // Search Submit
            elements.searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const type = elements.inputType.value;
                const origin = elements.inputOrigin.value;
                const destination = elements.inputDestination.value;
                const date = elements.inputDate.value;

                if (type !== 'Hotel' && !origin) {
                    alert("Vui lòng nhập điểm đi");
                    return;
                }

                // Show Loading
                elements.views.home.classList.add('hidden');
                elements.views.loading.classList.remove('hidden');
                
                try {
                    const data = await searchRealTimeTickets(origin, destination, date, type);
                    state.searchData = data;
                    elements.views.loading.classList.add('hidden');
                    renderResults(data, origin, destination, date, type);
                } catch (err) {
                    console.error(err);
                    elements.views.loading.classList.add('hidden');
                    elements.views.home.classList.remove('hidden');
                    alert("Có lỗi xảy ra khi tìm kiếm. Vui lòng thử lại.");
                }
            });

            // Chat Submit
            elements.chatForm.addEventListener('submit', handleChat);
        });

    </script>
    <footer><h1>có thể trang web hết api key free nên bạn không thể tìm kiếm được =))) khi nào bạn cho tôi tiền mua api thì sẽ xịn hơn</h1></footer>
</body>
</html>