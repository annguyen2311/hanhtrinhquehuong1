<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelGenie AI - Du Lịch Thông Minh</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #ffffff;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-gradient-animate {
            background: linear-gradient(-45deg, #1e1b4b, #312e81, #0f172a, #4c1d95);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 10px 30px -10px rgba(139, 92, 246, 0.3);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }

        .glass-input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
            background: rgba(15, 23, 42, 0.8);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #8b5cf6;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Background -->
    <div class="bg-gradient-animate"></div>

    <!-- Auth View (Login/Register) -->
    <section id="view-auth" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="glass w-full max-w-md p-8 rounded-3xl shadow-2xl border-t border-white/10 relative overflow-hidden">
            <!-- Background Glow -->
            <div class="absolute -top-20 -right-20 w-40 h-40 bg-purple-500/30 rounded-full blur-3xl pointer-events-none"></div>
            <div class="absolute -bottom-20 -left-20 w-40 h-40 bg-cyan-500/30 rounded-full blur-3xl pointer-events-none"></div>

            <div class="relative z-10">
                <div class="flex flex-col items-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-tr from-cyan-400 to-purple-600 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-purple-500/30">
                        <i data-lucide="plane" class="w-8 h-8 text-white"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-cyan-300 to-purple-300">TravelGenie AI</h1>
                    <p class="text-slate-400 text-center mt-2 text-sm">Đồng hành cùng bạn trên mọi nẻo đường</p>
                </div>

                <!-- Tabs -->
                <div class="flex bg-slate-800/50 rounded-xl p-1 mb-6">
                    <button id="tab-login" class="flex-1 py-2 rounded-lg text-sm font-medium bg-white/10 text-white shadow-sm transition-all">Đăng Nhập</button>
                    <button id="tab-register" class="flex-1 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white transition-all">Đăng Ký</button>
                </div>

                <!-- Login Form -->
                <form id="form-login" class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Email</label>
                        <input type="email" id="login-email" placeholder="email@example.com" required 
                            class="w-full glass-input px-4 py-3 rounded-xl text-sm placeholder-slate-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Mật khẩu</label>
                        <input type="password" id="login-password" placeholder="••••••••" required 
                            class="w-full glass-input px-4 py-3 rounded-xl text-sm placeholder-slate-500">
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg shadow-cyan-500/25 mt-2">
                        Đăng Nhập
                    </button>
                </form>

                <!-- Register Form -->
                <form id="form-register" class="space-y-4 hidden">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Họ và Tên</label>
                        <input type="text" id="reg-name" placeholder="Nguyễn Văn A" required 
                            class="w-full glass-input px-4 py-3 rounded-xl text-sm placeholder-slate-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Email</label>
                        <input type="email" id="reg-email" placeholder="email@example.com" required 
                            class="w-full glass-input px-4 py-3 rounded-xl text-sm placeholder-slate-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Mật khẩu</label>
                        <input type="password" id="reg-password" placeholder="••••••••" required 
                            class="w-full glass-input px-4 py-3 rounded-xl text-sm placeholder-slate-500">
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg shadow-purple-500/25 mt-2">
                        Tạo Tài Khoản
                    </button>
                </form>

                <p id="auth-error" class="text-red-400 text-xs text-center mt-4 hidden"></p>
            </div>
        </div>
    </section>

    <!-- App Container -->
    <div id="app" class="relative min-h-screen flex flex-col hidden">
        
        <!-- Navbar -->
        <nav class="sticky top-0 z-40 w-full glass border-b border-white/5">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <!-- Logo -->
                    <div class="flex items-center gap-2 cursor-pointer" onclick="navigateTo('home')">
                        <div class="w-8 h-8 bg-gradient-to-br from-cyan-400 to-purple-500 rounded-lg flex items-center justify-center">
                            <i data-lucide="plane" class="w-5 h-5 text-white"></i>
                        </div>
                        <span class="font-bold text-xl tracking-tight">TravelGenie</span>
                    </div>

                    <!-- Desktop Menu -->
                    <div class="hidden md:flex items-center space-x-8">
                        <a href="#" onclick="navigateTo('home')" class="nav-link text-sm font-medium text-white hover:text-cyan-400 transition-colors">Tìm kiếm</a>
                        <a href="#" onclick="navigateTo('chat')" class="nav-link text-sm font-medium text-slate-300 hover:text-cyan-400 transition-colors">Trợ lý AI</a>
                        <a href="#" onclick="navigateTo('profile')" class="nav-link text-sm font-medium text-slate-300 hover:text-cyan-400 transition-colors">Hồ sơ</a>
                    </div>

                    <!-- Mobile Menu Button & User -->
                    <div class="flex items-center gap-4">
                        <div id="user-indicator" class="hidden md:flex items-center gap-2 px-3 py-1.5 glass rounded-full border border-white/10">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span id="nav-username" class="text-xs font-medium text-slate-300">Khách</span>
                        </div>
                        <button class="md:hidden text-slate-300 hover:text-white">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-grow relative">
            
            <!-- VIEW: HOME (Search) -->
            <section id="view-home" class="view-section px-4 pt-10 pb-20">
                <div class="max-w-4xl mx-auto text-center mb-12">
                    <h1 class="text-4xl md:text-6xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-cyan-300 via-purple-300 to-pink-300">
                        Bạn muốn đi đâu tiếp theo?
                    </h1>
                    <p class="text-lg text-slate-400 max-w-2xl mx-auto">
                        Tìm kiếm vé máy bay, tàu hỏa, xe buýt và khách sạn theo thời gian thực cùng AI.
                    </p>
                </div>

                <!-- Search Box -->
                <div class="max-w-5xl mx-auto glass p-6 md:p-8 rounded-3xl shadow-2xl border border-white/10 relative overflow-hidden">
                    <!-- Glow effect behind -->
                    <div class="absolute -top-20 -right-20 w-64 h-64 bg-purple-500/20 rounded-full blur-3xl pointer-events-none"></div>
                    <div class="absolute -bottom-20 -left-20 w-64 h-64 bg-cyan-500/20 rounded-full blur-3xl pointer-events-none"></div>

                    <form id="search-form" class="relative z-10 grid grid-cols-1 md:grid-cols-12 gap-4">
                        
                        <!-- Origin -->
                        <div class="md:col-span-3 group">
                            <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Điểm đi</label>
                            <div class="relative">
                                <i data-lucide="map-pin" class="absolute left-3 top-3 w-5 h-5 text-slate-500 group-focus-within:text-cyan-400 transition-colors"></i>
                                <input type="text" id="input-origin" placeholder="Thành phố hoặc sân bay" required
                                    class="w-full glass-input pl-10 pr-4 py-3 rounded-xl text-sm focus:ring-0">
                            </div>
                        </div>

                        <!-- Destination -->
                        <div class="md:col-span-3 group">
                            <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Điểm đến</label>
                            <div class="relative">
                                <i data-lucide="navigation" class="absolute left-3 top-3 w-5 h-5 text-slate-500 group-focus-within:text-purple-400 transition-colors"></i>
                                <input type="text" id="input-destination" placeholder="Bạn muốn đến đâu?" required
                                    class="w-full glass-input pl-10 pr-4 py-3 rounded-xl text-sm focus:ring-0">
                            </div>
                        </div>

                        <!-- Date -->
                        <div class="md:col-span-2 group">
                            <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Ngày đi</label>
                            <div class="relative">
                                <input type="date" id="input-date" required
                                    class="w-full glass-input px-4 py-3 rounded-xl text-sm focus:ring-0 appearance-none text-slate-300">
                            </div>
                        </div>

                        <!-- Type -->
                        <div class="md:col-span-2 group">
                            <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Loại hình</label>
                            <div class="relative">
                                <i data-lucide="layers" class="absolute left-3 top-3 w-5 h-5 text-slate-500 group-focus-within:text-pink-400 transition-colors z-10"></i>
                                <select id="input-type" class="w-full glass-input pl-10 pr-4 py-3 rounded-xl text-sm focus:ring-0 appearance-none cursor-pointer relative z-0">
                                    <option value="Flight" class="bg-slate-800">Máy Bay</option>
                                    <option value="Train" class="bg-slate-800">Tàu Hỏa</option>
                                    <option value="Bus" class="bg-slate-800">Xe Buýt</option>
                                    <option value="Hotel" class="bg-slate-800">Khách Sạn</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-slate-500 pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Button -->
                        <div class="md:col-span-2 flex items-end">
                            <button type="submit" id="btn-search" 
                                class="w-full h-[46px] bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white font-semibold rounded-xl transition-all shadow-lg shadow-cyan-500/20 flex items-center justify-center gap-2 group">
                                <span class="group-hover:hidden">Tìm Kiếm</span>
                                <span class="hidden group-hover:inline">Đi Thôi</span>
                                <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Features Grid (Decorative) -->
                <div class="max-w-6xl mx-auto mt-20 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass p-6 rounded-2xl border border-white/5">
                        <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center mb-4 text-purple-400">
                            <i data-lucide="zap" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">AI Thời Gian Thực</h3>
                        <p class="text-slate-400 text-sm">Gemini quét web trực tiếp để tìm lịch trình và giá vé mới nhất cho bạn.</p>
                    </div>
                    <div class="glass p-6 rounded-2xl border border-white/5">
                        <div class="w-10 h-10 rounded-full bg-pink-500/20 flex items-center justify-center mb-4 text-pink-400">
                            <i data-lucide="heart" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Cá Nhân Hóa</h3>
                        <p class="text-slate-400 text-sm">Học hỏi sở thích để gợi ý những chuyến đi phù hợp nhất.</p>
                    </div>
                    <div class="glass p-6 rounded-2xl border border-white/5">
                        <div class="w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center mb-4 text-cyan-400">
                            <i data-lucide="shield-check" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Nguồn Tin Cậy</h3>
                        <p class="text-slate-400 text-sm">Dữ liệu minh bạch, liên kết trực tiếp đến nhà cung cấp dịch vụ.</p>
                    </div>
                </div>
            </section>

            <!-- VIEW: LOADING -->
            <section id="view-loading" class="view-section hidden absolute inset-0 flex flex-col items-center justify-center z-50 bg-slate-900/50 backdrop-blur-sm min-h-[500px]">
                <div class="relative">
                    <div class="w-20 h-20 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"></div>
                    <div class="absolute top-0 left-0 w-20 h-20 border-4 border-purple-500/30 border-b-purple-500 rounded-full animate-spin" style="animation-direction: reverse; animation-duration: 1.5s;"></div>
                    <i data-lucide="plane" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-6 h-6 text-white animate-pulse"></i>
                </div>
                <h3 class="mt-8 text-xl font-medium text-white">Đang quét bầu trời dữ liệu...</h3>
                <p id="loading-text" class="text-slate-400 mt-2 text-sm">Gemini đang tìm kiếm chuyến đi tốt nhất cho bạn</p>
            </section>

            <!-- VIEW: SEARCH RESULTS -->
            <section id="view-results" class="view-section hidden px-4 py-8">
                <div class="max-w-6xl mx-auto">
                    <!-- Results Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                        <div>
                            <button onclick="navigateTo('home')" class="flex items-center text-slate-400 hover:text-white mb-2 transition-colors">
                                <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Quay lại tìm kiếm
                            </button>
                            <h2 class="text-2xl font-bold flex items-center gap-2">
                                <span id="res-origin" class="text-slate-300">Điểm đi</span>
                                <i data-lucide="arrow-right" class="w-5 h-5 text-slate-500"></i>
                                <span id="res-destination" class="text-cyan-400">Điểm đến</span>
                            </h2>
                            <p class="text-sm text-slate-400 mt-1 flex items-center gap-2">
                                <i data-lucide="calendar" class="w-3 h-3"></i> <span id="res-date">Ngày</span>
                                <span class="mx-1">•</span>
                                <span id="res-count">0 kết quả tìm thấy</span>
                            </p>
                        </div>
                        
                        <div class="flex gap-2">
                            <button class="px-4 py-2 glass rounded-lg text-sm hover:bg-white/5 transition-colors">Rẻ nhất</button>
                            <button class="px-4 py-2 bg-white/10 text-white rounded-lg text-sm border border-cyan-500/50">Nhanh nhất</button>
                        </div>
                    </div>

                    <!-- Results Grid -->
                    <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Cards will be injected here via JS -->
                    </div>

                    <!-- Data Sources -->
                    <div class="mt-12 p-6 glass rounded-2xl border border-white/5">
                        <h4 class="text-sm font-semibold text-slate-300 mb-3 flex items-center gap-2">
                            <i data-lucide="link" class="w-4 h-4"></i> Nguồn Dữ Liệu
                        </h4>
                        <div id="sources-list" class="flex flex-wrap gap-2 text-xs text-slate-500">
                            <!-- Links injected here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: AI CHAT -->
            <section id="view-chat" class="view-section hidden h-[calc(100vh-64px)] flex flex-col">
                <div class="flex-1 overflow-y-auto p-4 space-y-4 max-w-4xl mx-auto w-full" id="chat-messages">
                    <!-- Welcome Message -->
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-cyan-500 to-blue-500 flex-shrink-0 flex items-center justify-center">
                            <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                        </div>
                        <div class="glass p-4 rounded-2xl rounded-tl-none max-w-[80%] text-sm text-slate-200">
                            Xin chào! Tôi là trợ lý du lịch AI của bạn. Hãy hỏi tôi về địa điểm, thủ tục visa, hoặc danh sách đồ cần chuẩn bị cho chuyến đi sắp tới nhé!
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="p-4 border-t border-white/10 glass bg-slate-900/80">
                    <form id="chat-form" class="max-w-4xl mx-auto relative flex gap-2">
                        <input type="text" id="chat-input" placeholder="Hỏi Gemini..." 
                            class="flex-1 glass-input px-4 py-3 rounded-xl focus:ring-0 text-sm">
                        <button type="submit" class="bg-cyan-600 hover:bg-cyan-500 text-white p-3 rounded-xl transition-colors">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
            </section>

            <!-- VIEW: PROFILE (Real Data) -->
            <section id="view-profile" class="view-section hidden px-4 py-10">
                <div class="max-w-2xl mx-auto glass rounded-3xl p-8 border border-white/10 text-center">
                    <div class="w-24 h-24 bg-gradient-to-br from-pink-500 to-orange-400 rounded-full mx-auto mb-4 p-1">
                        <img src="https://picsum.photos/200" alt="Avatar" class="w-full h-full rounded-full border-4 border-slate-900 object-cover">
                    </div>
                    <h2 id="profile-name" class="text-2xl font-bold text-white">User Name</h2>
                    <p id="profile-email" class="text-slate-400 text-sm mb-6">user@example.com</p>
                    
                    <div class="grid grid-cols-2 gap-4 text-left mb-8">
                        <div class="glass p-4 rounded-xl">
                            <p class="text-xs text-slate-500 uppercase">Chuyến đi</p>
                            <p class="text-2xl font-bold text-cyan-400">0</p>
                        </div>
                        <div class="glass p-4 rounded-xl">
                            <p class="text-xs text-slate-500 uppercase">Đã lưu</p>
                            <p class="text-2xl font-bold text-purple-400">0</p>
                        </div>
                    </div>
                    
                    <button id="btn-logout" class="w-full py-3 glass rounded-xl text-red-400 hover:bg-red-500/10 transition-colors text-sm font-medium">
                        Đăng Xuất
                    </button>
                </div>
            </section>

        </main>
    </div>

    <!-- MAIN SCRIPT -->
    <script type="module">
        import { GoogleGenAI } from "https://esm.run/@google/genai";

        // --- CONSTANTS & CONFIG ---
        // List of API Keys for rotation/fallback (Khóa chính và khóa dự phòng)
        const API_KEYS = [
            "AIzaSyDpiZ8LHJNPXd1VgtHFV7luhc5cbIt3cnM",
            "AIzaSyB78pNkaqTKqa_hZtruMGOHsFzwam58b-g"
        ];
        let currentKeyIndex = 0;

        const CITY_IMAGES = {
            "Hanoi": "https://images.unsplash.com/photo-1555921015-5532091f6026?auto=format&fit=crop&w=800&q=80",
            "Ha Noi": "https://images.unsplash.com/photo-1555921015-5532091f6026?auto=format&fit=crop&w=800&q=80",
            "Hà Nội": "https://images.unsplash.com/photo-1555921015-5532091f6026?auto=format&fit=crop&w=800&q=80",
            "Ho Chi Minh": "https://images.unsplash.com/photo-1583417319070-4a69db38a482?auto=format&fit=crop&w=800&q=80",
            "Saigon": "https://images.unsplash.com/photo-1583417319070-4a69db38a482?auto=format&fit=crop&w=800&q=80",
            "Hồ Chí Minh": "https://images.unsplash.com/photo-1583417319070-4a69db38a482?auto=format&fit=crop&w=800&q=80",
            "Da Nang": "https://images.unsplash.com/photo-1559592413-7cec4d0cae2b?auto=format&fit=crop&w=800&q=80",
            "Danang": "https://images.unsplash.com/photo-1559592413-7cec4d0cae2b?auto=format&fit=crop&w=800&q=80",
            "Đà Nẵng": "https://images.unsplash.com/photo-1559592413-7cec4d0cae2b?auto=format&fit=crop&w=800&q=80",
            "Sapa": "https://images.unsplash.com/photo-1534057357497-69502b48995a?auto=format&fit=crop&w=800&q=80",
            "Hoi An": "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=800&q=80",
            "Hội An": "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=800&q=80",
            "Phu Quoc": "https://images.unsplash.com/photo-1588665046200-c943891d4576?auto=format&fit=crop&w=800&q=80",
            "Phú Quốc": "https://images.unsplash.com/photo-1588665046200-c943891d4576?auto=format&fit=crop&w=800&q=80",
            "Ha Long": "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=800&q=80",
            "Halong": "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=800&q=80",
            "Hạ Long": "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=800&q=80",
            "Nha Trang": "https://images.unsplash.com/photo-1565620958189-e962657e3352?auto=format&fit=crop&w=800&q=80",
            "default": "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?auto=format&fit=crop&w=800&q=80"
        };

        // --- STATE MANAGEMENT ---
        const state = {
            currentUser: null,
            currentView: 'home',
            searchData: null,
            searchResults: []
        };

        // --- DOM ELEMENTS ---
        const elements = {
            app: document.getElementById('app'),
            viewAuth: document.getElementById('view-auth'),
            
            // Auth Elements
            tabLogin: document.getElementById('tab-login'),
            tabRegister: document.getElementById('tab-register'),
            formLogin: document.getElementById('form-login'),
            formRegister: document.getElementById('form-register'),
            authError: document.getElementById('auth-error'),
            
            // Main Views
            views: {
                home: document.getElementById('view-home'),
                results: document.getElementById('view-results'),
                chat: document.getElementById('view-chat'),
                profile: document.getElementById('view-profile'),
                loading: document.getElementById('view-loading')
            },
            
            // Search & Profile
            searchForm: document.getElementById('search-form'),
            resultsContainer: document.getElementById('results-container'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            chatMessages: document.getElementById('chat-messages'),
            resOrigin: document.getElementById('res-origin'),
            resDest: document.getElementById('res-destination'),
            resDate: document.getElementById('res-date'),
            resCount: document.getElementById('res-count'),
            sourcesList: document.getElementById('sources-list'),
            
            // Profile Info
            profileName: document.getElementById('profile-name'),
            profileEmail: document.getElementById('profile-email'),
            navUsername: document.getElementById('nav-username'),
            btnLogout: document.getElementById('btn-logout')
        };

        // --- GENAI WRAPPER (AUTO ROTATION) ---
        // Hàm này sẽ tự động thử key tiếp theo nếu key hiện tại bị lỗi
        async function callGeminiSafe(params) {
            let lastError = null;
            
            // Thử lần lượt các key bắt đầu từ key đang hoạt động (currentKeyIndex)
            for (let i = 0; i < API_KEYS.length; i++) {
                // Tính toán chỉ mục key cần thử (xoay vòng)
                const tryIndex = (currentKeyIndex + i) % API_KEYS.length;
                const apiKey = API_KEYS[tryIndex];
                
                try {
                    const ai = new GoogleGenAI({ apiKey: apiKey });
                    const response = await ai.models.generateContent(params);
                    
                    // Nếu thành công, cập nhật chỉ mục hiện tại để lần sau dùng tiếp key này
                    currentKeyIndex = tryIndex;
                    return response;
                } catch (error) {
                    console.warn(`API Key kết thúc bằng ...${apiKey.slice(-4)} bị lỗi (Index: ${tryIndex}). Đang thử key khác...`, error);
                    lastError = error;
                    // Tiếp tục vòng lặp để thử key tiếp theo
                }
            }
            
            // Nếu thử hết tất cả key mà vẫn lỗi thì ném lỗi ra
            throw lastError;
        }

        // --- AUTH & LOCAL STORAGE LOGIC ---
        function loadUsers() {
            const users = localStorage.getItem('tg_users');
            return users ? JSON.parse(users) : [];
        }

        function saveUser(user) {
            const users = loadUsers();
            users.push(user);
            localStorage.setItem('tg_users', JSON.stringify(users));
        }

        function findUser(email) {
            const users = loadUsers();
            return users.find(u => u.email === email);
        }

        function login(email, password) {
            const user = findUser(email);
            if (user && user.password === password) {
                state.currentUser = user;
                localStorage.setItem('tg_current_user', JSON.stringify(user));
                return true;
            }
            return false;
        }

        function logout() {
            state.currentUser = null;
            localStorage.removeItem('tg_current_user');
            window.location.reload(); // Refresh to reset state
        }

        // --- INITIALIZATION ---
        function init() {
            lucide.createIcons();
            
            // Check for Logged In User
            const storedUser = localStorage.getItem('tg_current_user');
            if (storedUser) {
                state.currentUser = JSON.parse(storedUser);
                updateProfileUI();
                showApp();
            } else {
                showAuth();
            }

            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('input-date').valueAsDate = tomorrow;
        }

        function updateProfileUI() {
            if (state.currentUser) {
                elements.profileName.textContent = state.currentUser.name;
                elements.profileEmail.textContent = state.currentUser.email;
                elements.navUsername.textContent = state.currentUser.name;
            }
        }

        function showAuth() {
            elements.viewAuth.classList.remove('hidden');
            elements.app.classList.add('hidden');
        }

        function showApp() {
            elements.viewAuth.classList.add('hidden');
            elements.app.classList.remove('hidden');
            navigateTo('home');
        }

        // --- AUTH EVENT HANDLERS ---
        // Switch Tabs
        elements.tabLogin.addEventListener('click', () => {
            elements.tabLogin.classList.replace('text-slate-400', 'text-white');
            elements.tabLogin.classList.replace('bg-transparent', 'bg-white/10');
            elements.tabLogin.classList.add('shadow-sm');

            elements.tabRegister.classList.replace('text-white', 'text-slate-400');
            elements.tabRegister.classList.replace('bg-white/10', 'bg-transparent');
            elements.tabRegister.classList.remove('shadow-sm');

            elements.formLogin.classList.remove('hidden');
            elements.formRegister.classList.add('hidden');
            elements.authError.classList.add('hidden');
        });

        elements.tabRegister.addEventListener('click', () => {
            elements.tabRegister.classList.replace('text-slate-400', 'text-white');
            elements.tabRegister.classList.replace('bg-transparent', 'bg-white/10');
            elements.tabRegister.classList.add('shadow-sm');

            elements.tabLogin.classList.replace('text-white', 'text-slate-400');
            elements.tabLogin.classList.replace('bg-white/10', 'bg-transparent');
            elements.tabLogin.classList.remove('shadow-sm');

            elements.formRegister.classList.remove('hidden');
            elements.formLogin.classList.add('hidden');
            elements.authError.classList.add('hidden');
        });

        // Handle Login
        elements.formLogin.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;

            if (login(email, pass)) {
                updateProfileUI();
                showApp();
            } else {
                elements.authError.textContent = "Email hoặc mật khẩu không chính xác.";
                elements.authError.classList.remove('hidden');
            }
        });

        // Handle Register
        elements.formRegister.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;

            if (findUser(email)) {
                elements.authError.textContent = "Email này đã được đăng ký.";
                elements.authError.classList.remove('hidden');
                return;
            }

            const newUser = { name, email, password: pass };
            saveUser(newUser);
            
            // Auto login after register
            login(email, pass);
            updateProfileUI();
            showApp();
        });

        // Handle Logout
        elements.btnLogout.addEventListener('click', logout);

        // --- NAVIGATION ---
        window.navigateTo = (viewName) => {
            // Hide all views
            Object.values(elements.views).forEach(el => {
                if(!el.id.includes('loading')) el.classList.add('hidden');
            });
            
            // Show target view
            if (elements.views[viewName]) {
                elements.views[viewName].classList.remove('hidden');
                state.currentView = viewName;
            }
            window.scrollTo(0, 0);
        };

        // --- SEARCH LOGIC (GENAI) ---
        elements.searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const origin = document.getElementById('input-origin').value;
            const destination = document.getElementById('input-destination').value;
            const date = document.getElementById('input-date').value;
            const type = document.getElementById('input-type').value;

            state.searchData = { origin, destination, date, type };

            // UI Updates
            elements.views.loading.classList.remove('hidden');
            document.getElementById('loading-text').innerText = `Đang tìm ${type === 'Flight' ? 'chuyến bay' : type === 'Train' ? 'tàu hỏa' : 'khách sạn'} đi ${destination}...`;

            try {
                // Call Gemini via Safe Wrapper
                const results = await searchRealTimeTickets(origin, destination, date, type);
                renderResults(results, destination);
                navigateTo('results');
            } catch (error) {
                console.error("Search failed:", error);
                alert("Tìm kiếm thất bại. Vui lòng thử lại sau.");
                navigateTo('home');
            } finally {
                elements.views.loading.classList.add('hidden');
            }
        });

        async function searchRealTimeTickets(from, to, date, type) {
            const prompt = `
            Find real-world ${type} tickets from ${from} to ${to} on ${date}.
            Return a JSON array ONLY (no markdown, no extra text) with the following objects:
            {
                "company": "Airline or Company Name",
                "departure": "HH:MM",
                "arrival": "HH:MM",
                "duration": "e.g. 2h 30m",
                "price": "e.g. 1,500,000 VND",
                "rating": "4.5",
                "link": "Booking URL"
            }
            Find at least 5 options. Ensure prices are in VND if possible.
            `;

            // Use callGeminiSafe instead of direct call
            const response = await callGeminiSafe({
                model: 'gemini-2.5-flash',
                contents: prompt,
                config: {
                    tools: [{ googleSearch: {} }],
                }
            });

            // Handle Grounding Metadata (Sources)
            const sources = response.candidates?.[0]?.groundingMetadata?.groundingChunks || [];
            renderSources(sources);

            // Parse JSON Response
            let text = response.text;
            // Clean markdown if present
            text = text.replace(/```json/g, '').replace(/```/g, '').trim();
            
            try {
                return JSON.parse(text);
            } catch (e) {
                console.error("Failed to parse JSON:", text);
                return []; // Return empty if parsing fails
            }
        }

        function renderResults(data, destination) {
            elements.resOrigin.textContent = state.searchData.origin;
            elements.resDest.textContent = state.searchData.destination;
            elements.resDate.textContent = state.searchData.date;
            elements.resCount.textContent = `${data.length} kết quả`;

            elements.resultsContainer.innerHTML = '';

            // Get Image
            let imgUrl = CITY_IMAGES['default'];
            // Simple fuzzy match for image
            for (const city in CITY_IMAGES) {
                if (destination.toLowerCase().includes(city.toLowerCase())) {
                    imgUrl = CITY_IMAGES[city];
                    break;
                }
            }

            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'glass-card rounded-2xl overflow-hidden group';
                card.innerHTML = `
                    <div class="h-32 bg-slate-800 relative overflow-hidden">
                        <img src="${imgUrl}" alt="${destination}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>
                        <div class="absolute bottom-2 left-4 text-white font-bold">${item.company}</div>
                        <div class="absolute top-2 right-2 bg-slate-900/80 backdrop-blur px-2 py-1 rounded-lg text-xs flex items-center gap-1 text-yellow-400 border border-yellow-500/20">
                            <i data-lucide="star" class="w-3 h-3 fill-current"></i> ${item.rating}
                        </div>
                    </div>
                    <div class="p-5">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <div class="text-xl font-bold text-white">${item.departure}</div>
                                <div class="text-xs text-slate-400">${state.searchData.origin}</div>
                            </div>
                            <div class="flex flex-col items-center px-4">
                                <div class="text-xs text-slate-500 mb-1">${item.duration}</div>
                                <div class="w-full h-[1px] bg-slate-600 relative flex items-center justify-center w-16">
                                    <div class="w-2 h-2 rounded-full bg-slate-600 absolute -left-1"></div>
                                    <i data-lucide="plane" class="w-3 h-3 text-slate-400 rotate-90"></i>
                                    <div class="w-2 h-2 rounded-full bg-slate-600 absolute -right-1"></div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold text-white">${item.arrival || '--:--'}</div>
                                <div class="text-xs text-slate-400">${destination}</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between pt-4 border-t border-white/5">
                            <div class="text-cyan-400 font-bold text-lg">${item.price}</div>
                            <a href="${item.link}" target="_blank" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white text-sm rounded-xl transition-colors">
                                Đặt Ngay
                            </a>
                        </div>
                    </div>
                `;
                elements.resultsContainer.appendChild(card);
            });
            
            // Re-render icons for new elements
            lucide.createIcons();
        }

        function renderSources(sources) {
            elements.sourcesList.innerHTML = '';
            sources.forEach(source => {
                if (source.web) {
                    const a = document.createElement('a');
                    a.href = source.web.uri;
                    a.target = "_blank";
                    a.className = "bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded text-slate-300 transition-colors truncate max-w-[150px]";
                    a.textContent = source.web.title || source.web.uri;
                    elements.sourcesList.appendChild(a);
                }
            });
        }

        // --- AI CHAT LOGIC ---
        elements.chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = elements.chatInput.value.trim();
            if (!input) return;

            // Add User Message
            appendMessage('user', input);
            elements.chatInput.value = '';

            try {
                // Call Gemini for Chat via Safe Wrapper
                const prompt = `Bạn là một trợ lý du lịch hữu ích, nói tiếng Việt. Hãy trả lời câu hỏi sau của người dùng một cách ngắn gọn và thân thiện: "${input}"`;
                
                const response = await callGeminiSafe({
                    model: 'gemini-2.5-flash',
                    contents: prompt
                });

                appendMessage('ai', response.text);

            } catch (error) {
                console.error("Chat error:", error);
                appendMessage('ai', "Xin lỗi, tôi đang gặp sự cố kết nối. Vui lòng thử lại sau.");
            }
        });

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex items-start gap-3 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            const avatar = role === 'user' 
                ? `<div class="w-8 h-8 rounded-full bg-slate-700 flex-shrink-0 flex items-center justify-center"><i data-lucide="user" class="w-5 h-5 text-slate-300"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-cyan-500 to-blue-500 flex-shrink-0 flex items-center justify-center"><i data-lucide="bot" class="w-5 h-5 text-white"></i></div>`;

            const bubbleClass = role === 'user'
                ? "bg-cyan-600 text-white rounded-tr-none"
                : "glass text-slate-200 rounded-tl-none";

            div.innerHTML = `
                ${avatar}
                <div class="${bubbleClass} p-4 rounded-2xl max-w-[80%] text-sm leading-relaxed shadow-md">
                    ${text}
                </div>
            `;
            
            elements.chatMessages.appendChild(div);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            lucide.createIcons();
        }

        // --- START APP ---
        init();

    </script>
</body>
</html>
